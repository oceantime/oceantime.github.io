---
> **ARTS-week-13**
> 2023-03-26 9:31
---


## ARTS-2019 左耳听风社群活动--每周完成一个 ARTS
1.Algorithm: 每周至少做一个 leetcode 的算法题
2.Review: 阅读并点评至少一篇英文技术文章
3.Tip: 学习至少一个技术技巧
4.Share: 分享一篇有观点和思考的技术文章

### 1.Algorithm:

- [1626. 无矛盾的最佳球队](https://leetcode.cn/submissions/detail/416204241/)  
    + 思路：排序+DP
- [1630. 等差子数组](https://leetcode.cn/submissions/detail/416626068/)  
    + 思路：模拟
- [1574. 删除最短的子数组使剩余数组有序](https://leetcode.cn/submissions/detail/417381068/)  
    + 思路：双指针

### 2.Review:

[我们如何在不停机的情况下升级旧的 3PB 大型 Elasticsearch 集群。第 4 部分 - 所有语言中高召回率的标记化和规范化](https://underthehood.meltwater.com/blog/2022/12/02/how-we-upgraded-an-old-3pb-large-elasticsearch-cluster-without-downtime-part-4-tokenization-and-normalization-for-high-recall-in-all-languages/)

介绍如何在不停机的情况下升级 Elasticsearch 集群，并将用户影响降至最低。

#### 1、挑战旧真理

重新处理所有数据的决定，加上组织其他部门实际改进的授权，为我们提供了这个独特的机会，可以对数据的索引方式进行非常低级别的更改。

这种自由最好的一点是，它使我们能够超越当前系统的限制，解决原本成本太高而无法在其他时间完成的问题。

这种自由最糟糕的地方还在于，它允许我们超越当前制度的限制，因为我们必须决定改变什么，保留什么。我们必须在为我们的系统添加期待已久的有价值的改进与同时更改太多内容时增加项目风险之间走一条细线。

我们的搜索引擎不仅仅是一个内部工具，而是影响整个组织的东西。最重要的是，我们还有数以万计的付费客户，他们反过来在我们的系统中有超过 800，000 个保存的搜索，他们希望在升级之前、期间和之后“继续工作”。

这种“向后兼容”的要求与我们的其他愿望直接相反;改进我们分析、标记化和规范化内容的方式。

#### 2、弹性搜索中的标记化

标记化是 elasticsearch 在幕后工作的基本部分，对于我们 Meltwater 来说，能够完全控制它的工作方式非常重要。我们需要能够向用户解释为什么或为什么某个文档与某个查询不匹配。

为了简要解释什么是标记化，我们可以将解释分为两部分：
  - 标记化是将文本和查询转换为标记的过程
  - Elasticsearch 只对 tokens 进行低级精确匹配
当将文档添加到 Elasticsearch 时，会创建一个倒排索引。简而言之，这类似于一个表，其中文档中的每个标记都是标识符，文档 ID 是值。如果想要一个简单的心智模型，可以说每个单词都对应于它自己的 token。

例如，这些文档：
```
Id 1: “meltwater use elasticsearch”
Id 2: “elasticsearch is used for search”
Id 3: “search is fast”
```

将生成如下所示的倒排索引：

|   token   |  index  |
| ------------- | ----- |
| meltwater     | [1]   |
| use           | [1]   |
| elasticsearch | [1,2] |
| is            | [2,3] |
| used          | [2]   |
| for           | [2]   |
| search        | [2,3] |
| fast          | [3]   |

搜索 elasticsearch 对应于在该表中查找令牌 elasticsearch，然后返回指向文档 1 和 2 的 [1，2]。搜索 elastic 不会给出任何命中，因为表中不存在该确切的 token 。使用查询也不会与包含所用 token 的文档匹配，因为这些 token 不同。

标记化是称为分析的过程的一部分，Elasticsearch 对文本执行该过程以创建适合用例的 token 。分词器(tokenizer)会将文本拆分为标记，许多筛选器可以通过各种方式修改文本和标记。
- 分词器的一种简单形式是将文本拆分为空白。
- 可以应用的筛选器示例可以是添加同义词、进行词干提取或词形还原（将每个单词减少到其根形式），或者完全更改或删除某些字符。

在 Meltwater，我们希望为客户提供进行非常精确查询的能力，这必须适用于所有语言。我们的 AI 语言检测支持 241 种语言，但即使是该集合之外的语言也经常添加到我们的集群中。为了实现这一点，我们使用了一个自定义的 icu 标记器，它创建的 token 比标准标记多得多。默认分词器行为的一个示例是删除所有标点符号和货币符号，同时我们希望将它们保留为单独的标记，以便可以查询它们。

值得注意的是，关于标记化，一旦文档被标记化并存储在磁盘上，就不容易更改。任何更改都需要对所有数据进行完全重新索引，并且由于我们有大量的文档，这可能需要数月时间！

在升级项目期间，我们希望确保我们所做的任何修改都不会产生任何意想不到的副作用。为了实现这一目标，我们首先设置了大型基于属性的自动化测试来比较新旧实现，一旦我们有了两个并行集群，我们就可以开始在新设置中重播实际的实时客户查询，以确保我们的所有更改都符合我们的意图。

#### 3、字符规范化

自从我们在 2013 年设计了旧的 Elasticsearch 集群以来，Meltwater 和世界都发生了重大变化。我们的数据集不仅变得更大，包含更多的语言，而且文本也包含更多不同的字符。其中一个原因是，我们开始索引更多的社交数据，使用更短的文本和更“创造性”的表达方式。

我们的客户对我们的搜索解决方案有两个相互冲突的需求，他们希望获得与其查询匹配的所有内容（完美召回），但他们也只希望获得与其查询匹配的匹配项（完美精度）。

为了实现这一点，一些客户必须编写非常大且精确的查询，以确保获得所有匹配项，而不管语言、字符集、词尾、拼写错误和书写方式如何。

我们认为我们可以更好地帮助用户的一个领域是改进字符规范化。通过将归一化器引入索引管道，我们可以控制这一关键部分，并希望提供更高的召回率，同时仍然保持用户最关心的零件的高精度。

但是，我们必须小心，因为规范化字符将有效地删除专门搜索（或排除）该字符的功能。由于我们还必须处理世界上所有的语言，因此几乎不可能知道某种语言中某个字符的含义。例如，作为瑞典人，将 é 规范化为 e 以涵盖拼写错误似乎是一个好主意，而法国人绝对会不同意！

#### 4、规范化撇号

因此，我们从最终用户、支持人员和销售部门收集了非常详细的要求。然后，我们列出了想要解决的具体已知问题。最常见的抱怨之一是撇号。例如：

```
John’s
and
John´s
```

不被视为相同的术语，因为撇号字符不同，因此搜索其中一个字符不会匹配另一个。这给我们的用户带来了很多麻烦和错过的比赛。有些人试图用通配符来反驳这一点，但这会使搜索变得缓慢且不可预测。

一种解决方案当然是完全删除索引和查询中的所有撇号，但这会导致其他问题。我们的客户希望能够有时专门搜索带有撇号的单词;John's和Johns是不同的术语，差异有时很重要，特别是对于品牌名称。

因此，我们确定了文档中发现的几个不同的撇号

```
[ ʹ ʻ ʼ ʽ ʾ ʿ ΄ ᾿ Ꞌ ꞌ ' ‘ ’ ‛ ′ ´ ` ｀ ＇]
```

并设置映射字符过滤器以将它们全部规范化为“.


#### 5、规范化全角字符

我们所做的另一项改进是规范化全角拉丁字符。这些字符是 Unicode 的一项功能，专门设计用于提供近似正方形的字符版本，以便更好地与其他语言（如中文、日语或韩语）的字符混合。

这意味着我们的客户可能不得不搜索

```
Meltwater OR Ｍｅｌｔｗａｔｅｒ
```

以确保获得完整的召回。

某些日语字符的情况也相反，它们被缩小以适应拉丁字母，这些字符称为半角字符。

通过设置另一个字符筛选器来规范化这两个特定的 Unicode 字符范围，用户现在可以搜索而无需添加额外的 OR 子句。

我们的用户喜欢这两个修复程序！他们现在可以显著减少查询的长度和构建查询所需的时间。而且其中许多执行速度也更快。

事实上，仅这两项变化就足以让我们的销售和支持组织的升级感到兴奋。

#### 6、中日韩脚本字符

在规范化成功的鼓励下，我们继续处理另一个问题，即如何处理基于语标的语言。特别是中日韩（中文、日文和韩文的统称）

首先，我们需要解释术语语标在语言上下文中的含义。语标只是意味着一种书写形式，其中每个字符代表一个完整的单词，而音韵则每个字符代表一个声音。英语和其他基于拉丁字符的语言是语音语言，CJK 是标志语言。

当涉及到标记化时，将文本转换为可搜索令牌的任务，语音语言具有优势。由于单词分隔符（例如空格），单词通常很容易识别。另一方面，对于中日韩来说，任何字符都可以是一个单词，或者任何字符组合也可以是一个单词。

例如，在中文中，貓头鷹的意思是猫头鹰，但个别字符的意思是猫头鹰。

我们的旧 CJK 算法将分别索引每个字符，这意味着在中文搜索时，对cat的查询会命中owl，因为它包含该标记。这意味着，对于仅返回与 cat 实际相关的文档的查询，需要添加多个排除项以删除不相关的匹配项。

我们看到了简化这一点的可能性，因此我们使用了一种算法，该算法利用综合字典来确保实际有效单词的组合被索引。

但是，在介绍此解决方案并在真实数据上进行测试后，事实证明我们的客户更喜欢处理 CJK 文本的旧方法。他们已经成为编写特定类型排除的专家，并且在这种情况下，对我们旧实现的更高召回率比编写较短查询的能力更有价值，他们希望我们没有更改任何东西。

#### 7、标记化和规范化更改后的学习

我们从这些经历中吸取了一些重要的教训：

为了以可预测和可解释的方式满足客户的需求，重要的是要全面了解完整的分析和标记化过程
尽早发布，并尽可能多地将客户反馈纳入的流程。
有时，技术上最优雅的解决方案可能不适合最终用户的需求。

许多自动化测试非常适合保证向后兼容性。
作为一个面向后端的团队，我们面临的挑战是我们的日常工作不包括与实际最终用户的太多互动。幸运的是，我们始终有一个秘密武器，即我们的全球客户支持团队，可以帮助我们进行测试并提供宝贵的见解。如果没有他们的帮助，我们可能会在项目过程中犯更多像上面这样的错误。

### 3.Tip:

#### CAST()函数，（CAST AS decimal）

语法：

CAST (expression AS data_type)

参数说明：

expression：任何有效的 SQServer 表达式。

例，精度与小数位数分别为9与2。这表示本例能够支持的最大的整数值是9999999，而最小的小数是0.01。
```shell
SELECT CAST(‘12.5’ AS decimal(9,2))
decimal数据类型在结果网格中将显示有效小数位: 12.50

SELECT CAST(‘12.5’ AS decimal)
结果是一个整数值：12

SELECT CAST(‘12’ AS int)
结果是一个：12
```

#### PowerMock + Mockito 报错 Could not reconfigure JMX java.lang.LinkageError 解决方案
参考：Ryan Chapin: Full-Stack Software Architect/Engineer, Drummer, Motorcyclist, Artist
```shell
@PowerMockIgnore({"javax.management.*"})
```

#### linux 查看磁盘 io 使用情况

top 命令、vmstat 命令、iostat 命令、iotop 命令、pt-ioprofile 命令、pidstat 命令

### 4.Share:

[基于PowerMockito的静态方法的多种mock测试方式](https://blog.csdn.net/BAStriver/article/details/106791775)  

[Ryan Chapin: Full-Stack Software Architect/Engineer, Drummer, Motorcyclist, Artist](http://www.ryanchapin.com/fv-b-4-816/Java-PowerMock-Could-not-reconfigure-JMX-java-lang-LinkageError-Solution.html)

[idea maven 项目 pom 文件有删除线解决办法](https://blog.csdn.net/keplerpig/article/details/115351112)

[如何在Java中将InputStream转换为File](https://blog.csdn.net/cyan20115/article/details/106554092)