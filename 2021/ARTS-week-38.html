<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>ARTS-week-38 | Oceantime&#39;s blog</title>
    <meta name="generator" content="VuePress 1.5.3">
    <link rel="icon" href="/logo.jpg">
    <meta name="description" content="Oceantime 个人网站">
    <link rel="preload" href="/assets/css/0.styles.abfd12c2.css" as="style"><link rel="preload" href="/assets/js/app.65b0f24a.js" as="script"><link rel="preload" href="/assets/js/2.d6ca9a42.js" as="script"><link rel="preload" href="/assets/js/116.ef676fd0.js" as="script"><link rel="prefetch" href="/assets/js/10.ad6941e4.js"><link rel="prefetch" href="/assets/js/100.8ade9f63.js"><link rel="prefetch" href="/assets/js/101.a15dfa49.js"><link rel="prefetch" href="/assets/js/102.761bd3ff.js"><link rel="prefetch" href="/assets/js/103.4e1cd420.js"><link rel="prefetch" href="/assets/js/104.6cfd7216.js"><link rel="prefetch" href="/assets/js/105.e2d93a01.js"><link rel="prefetch" href="/assets/js/106.6151bc8f.js"><link rel="prefetch" href="/assets/js/107.ad872ea3.js"><link rel="prefetch" href="/assets/js/108.bc756e31.js"><link rel="prefetch" href="/assets/js/109.fe77c5ed.js"><link rel="prefetch" href="/assets/js/11.f05321e1.js"><link rel="prefetch" href="/assets/js/110.39bd8ea8.js"><link rel="prefetch" href="/assets/js/111.bd5d0a8b.js"><link rel="prefetch" href="/assets/js/112.66f93d20.js"><link rel="prefetch" href="/assets/js/113.e3f1b94f.js"><link rel="prefetch" href="/assets/js/114.6ca21a56.js"><link rel="prefetch" href="/assets/js/115.2369b994.js"><link rel="prefetch" href="/assets/js/117.7762c22c.js"><link rel="prefetch" href="/assets/js/118.dc732d76.js"><link rel="prefetch" href="/assets/js/119.2b7f1a4d.js"><link rel="prefetch" href="/assets/js/12.b607cc9e.js"><link rel="prefetch" href="/assets/js/120.1b132ede.js"><link rel="prefetch" href="/assets/js/121.ff9a3172.js"><link rel="prefetch" href="/assets/js/122.2f47d49f.js"><link rel="prefetch" href="/assets/js/13.67af4ad6.js"><link rel="prefetch" href="/assets/js/14.c7827c0f.js"><link rel="prefetch" href="/assets/js/15.eedb1566.js"><link rel="prefetch" href="/assets/js/16.fe37cbf7.js"><link rel="prefetch" href="/assets/js/17.a38f0ae2.js"><link rel="prefetch" href="/assets/js/18.4990ee61.js"><link rel="prefetch" href="/assets/js/19.f4dbb6de.js"><link rel="prefetch" href="/assets/js/20.9ffd67c9.js"><link rel="prefetch" href="/assets/js/21.ac6e1d53.js"><link rel="prefetch" href="/assets/js/22.76b0e02e.js"><link rel="prefetch" href="/assets/js/23.ff3410dc.js"><link rel="prefetch" href="/assets/js/24.f76a6fea.js"><link rel="prefetch" href="/assets/js/25.0534f43c.js"><link rel="prefetch" href="/assets/js/26.c3725782.js"><link rel="prefetch" href="/assets/js/27.deb9c9f3.js"><link rel="prefetch" href="/assets/js/28.6f99ddc2.js"><link rel="prefetch" href="/assets/js/29.02cfc711.js"><link rel="prefetch" href="/assets/js/3.9f6270c9.js"><link rel="prefetch" href="/assets/js/30.ccabc2c3.js"><link rel="prefetch" href="/assets/js/31.b08f8990.js"><link rel="prefetch" href="/assets/js/32.ee62ba38.js"><link rel="prefetch" href="/assets/js/33.f7629f38.js"><link rel="prefetch" href="/assets/js/34.2853c933.js"><link rel="prefetch" href="/assets/js/35.97e611fd.js"><link rel="prefetch" href="/assets/js/36.fa3c8ed4.js"><link rel="prefetch" href="/assets/js/37.8ae8d904.js"><link rel="prefetch" href="/assets/js/38.05c35d7b.js"><link rel="prefetch" href="/assets/js/39.e5258c9e.js"><link rel="prefetch" href="/assets/js/4.ecc02e05.js"><link rel="prefetch" href="/assets/js/40.d668fe84.js"><link rel="prefetch" href="/assets/js/41.c09eb1d5.js"><link rel="prefetch" href="/assets/js/42.b940c3f3.js"><link rel="prefetch" href="/assets/js/43.5f4e8385.js"><link rel="prefetch" href="/assets/js/44.7231a1e4.js"><link rel="prefetch" href="/assets/js/45.585825f0.js"><link rel="prefetch" href="/assets/js/46.14ddc0e4.js"><link rel="prefetch" href="/assets/js/47.52d53fb0.js"><link rel="prefetch" href="/assets/js/48.01214996.js"><link rel="prefetch" href="/assets/js/49.a8e7ddc6.js"><link rel="prefetch" href="/assets/js/5.755ee6e4.js"><link rel="prefetch" href="/assets/js/50.8ef31d09.js"><link rel="prefetch" href="/assets/js/51.86c845e5.js"><link rel="prefetch" href="/assets/js/52.0d1a6570.js"><link rel="prefetch" href="/assets/js/53.0b2ca6b6.js"><link rel="prefetch" href="/assets/js/54.daa0b522.js"><link rel="prefetch" href="/assets/js/55.b7e6d8cc.js"><link rel="prefetch" href="/assets/js/56.67e22da8.js"><link rel="prefetch" href="/assets/js/57.1b8d87fd.js"><link rel="prefetch" href="/assets/js/58.4ef89df1.js"><link rel="prefetch" href="/assets/js/59.abdf0f5c.js"><link rel="prefetch" href="/assets/js/6.3df7280b.js"><link rel="prefetch" href="/assets/js/60.35f8805b.js"><link rel="prefetch" href="/assets/js/61.68fa7ebd.js"><link rel="prefetch" href="/assets/js/62.fd6b0085.js"><link rel="prefetch" href="/assets/js/63.af0dbde2.js"><link rel="prefetch" href="/assets/js/64.16a1ffec.js"><link rel="prefetch" href="/assets/js/65.af1a9908.js"><link rel="prefetch" href="/assets/js/66.0ab56108.js"><link rel="prefetch" href="/assets/js/67.7b28f376.js"><link rel="prefetch" href="/assets/js/68.be9ab4b2.js"><link rel="prefetch" href="/assets/js/69.c030abbd.js"><link rel="prefetch" href="/assets/js/7.3549904d.js"><link rel="prefetch" href="/assets/js/70.1469061c.js"><link rel="prefetch" href="/assets/js/71.4802b635.js"><link rel="prefetch" href="/assets/js/72.83cb541b.js"><link rel="prefetch" href="/assets/js/73.3ad064c7.js"><link rel="prefetch" href="/assets/js/74.00cd90be.js"><link rel="prefetch" href="/assets/js/75.cbf47e0f.js"><link rel="prefetch" href="/assets/js/76.44ccee9d.js"><link rel="prefetch" href="/assets/js/77.e9c38d7e.js"><link rel="prefetch" href="/assets/js/78.9122406c.js"><link rel="prefetch" href="/assets/js/79.5478a7f9.js"><link rel="prefetch" href="/assets/js/8.183e1cde.js"><link rel="prefetch" href="/assets/js/80.81f8b615.js"><link rel="prefetch" href="/assets/js/81.ceada5ea.js"><link rel="prefetch" href="/assets/js/82.6106ff2d.js"><link rel="prefetch" href="/assets/js/83.59665864.js"><link rel="prefetch" href="/assets/js/84.14e761a8.js"><link rel="prefetch" href="/assets/js/85.dd1f6fdb.js"><link rel="prefetch" href="/assets/js/86.c780faa6.js"><link rel="prefetch" href="/assets/js/87.b6a78c96.js"><link rel="prefetch" href="/assets/js/88.e6f83878.js"><link rel="prefetch" href="/assets/js/89.3b38af38.js"><link rel="prefetch" href="/assets/js/9.d9ab8dd1.js"><link rel="prefetch" href="/assets/js/90.64e54699.js"><link rel="prefetch" href="/assets/js/91.b0c97860.js"><link rel="prefetch" href="/assets/js/92.a49f1aa9.js"><link rel="prefetch" href="/assets/js/93.30383993.js"><link rel="prefetch" href="/assets/js/94.e5ff08c3.js"><link rel="prefetch" href="/assets/js/95.6ee9cb6c.js"><link rel="prefetch" href="/assets/js/96.829351f9.js"><link rel="prefetch" href="/assets/js/97.dcf9c2e9.js"><link rel="prefetch" href="/assets/js/98.58af886e.js"><link rel="prefetch" href="/assets/js/99.d137b7f6.js">
    <link rel="stylesheet" href="/assets/css/0.styles.abfd12c2.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Oceantime's blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/accumulate/" class="nav-link">
  前端基础
</a></div><div class="nav-item"><a href="/algorithm/" class="nav-link">
  算法题库
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/accumulate/" class="nav-link">
  前端基础
</a></div><div class="nav-item"><a href="/algorithm/" class="nav-link">
  算法题库
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>ARTS-week-38</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/2021/ARTS-week-38.html#arts-2019-左耳听风社群活动-每周完成一个-arts" class="sidebar-link">ARTS-2019 左耳听风社群活动--每周完成一个 ARTS</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/2021/ARTS-week-38.html#_1-algorithm" class="sidebar-link">1.Algorithm:</a></li><li class="sidebar-sub-header"><a href="/2021/ARTS-week-38.html#_2-review" class="sidebar-link">2.Review:</a></li><li class="sidebar-sub-header"><a href="/2021/ARTS-week-38.html#_3-tip" class="sidebar-link">3.Tip:</a></li><li class="sidebar-sub-header"><a href="/2021/ARTS-week-38.html#_4-share" class="sidebar-link">4.Share:</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="arts-2019-左耳听风社群活动-每周完成一个-arts"><a href="#arts-2019-左耳听风社群活动-每周完成一个-arts" class="header-anchor">#</a> ARTS-2019 左耳听风社群活动--每周完成一个 ARTS</h2> <p>1.Algorithm： 每周至少做一个 leetcode 的算法题
2.Review: 阅读并点评至少一篇英文技术文章
3.Tip: 学习至少一个技术技巧
4.Share: 分享一篇有观点和思考的技术文章</p> <h3 id="_1-algorithm"><a href="#_1-algorithm" class="header-anchor">#</a> 1.Algorithm:</h3> <ol start="380"><li><p>O(1) 时间插入、删除和获取随机元素：https://leetcode-cn.com/submissions/detail/217371971/</p></li> <li><p>滑动窗口最大值：https://leetcode-cn.com/submissions/detail/218046821/</p></li> <li><p>数组大小减半：https://leetcode-cn.com/submissions/detail/218060935/</p></li></ol> <h3 id="_2-review"><a href="#_2-review" class="header-anchor">#</a> 2.Review:</h3> <p>https://hackernoon.com/the-rise-of-robots-insights-into-the-global-robotics-market-374g3u2q
机器人的兴起：洞察2020全球机器人市场【Part 1】</p> <h4 id="点评："><a href="#点评：" class="header-anchor">#</a> 点评：</h4> <p>2020年是科幻剧作家卡雷尔-卡佩克首次提出 &quot;机器人 &quot;一词的一百年。40年后，1961年，通用汽车公司安装了世界上第一个工业机器人，为自动化生产和可编程机器时代铺平了道路。今天，全球工业机器人市场每年价值480亿美元，对机器人技术的需求正在快速增长。这是在第四次工业革命和数字技术进步的背景下，使机器人技术的使用更加民主化。</p> <p>在本文中，我们分析了全球机器人市场的增长，确定了推动需求的主要趋势。</p> <ul><li>在第一部分，我们探讨了数字技术的影响和 &quot;先进 &quot;机器人的出现。</li> <li>在第二部分中，我们分析了哪些行业正在推动对先进机器人的需求，并对供应链自动化进行了深入研究。</li> <li>在第三部分中，我们剖析了更广泛的机器人生态系统，确定了提供机器人硬件、软件和配件的主要市场参与者。</li></ul> <p>第一部分：更智能、更便宜、更快</p> <ul><li><p>最新一代的 &quot;高级 &quot;机器人结合了完整的技术堆栈，将物理自动化与数字效率相结合。因此，&quot;高级 &quot;机器人能够产生传统机器人无法产生的价值。</p> <ul><li>云技术：如今出货的机器人中，有90%能够连接到云端，而2016年这一比例还不到50%。这有利于远程监控、实时协作，在数据收集&amp;异地分析方面有了显著的进步。</li> <li>先进的传感器和机器视觉，让机器人发展出空间意识，这对自主移动和精准拣选至关重要。</li> <li>AI和机器学习，让机器人应用逻辑并有效地自动决策，增加了最后一层复杂性。</li></ul></li> <li><p>工业机器人的价格从未如此便宜，操作也从未如此简单，随着机器人价格持续下降，我们预计将出现两个主要拐点。</p> <ul><li>进一步的通货紧缩压力将加速工业中小企业的兴趣，这些企业由于成本和复杂性，传统上都避免使用机器人自动化。在欧洲，有超过200万家中小型制造企业，雇用了欧洲大陆1700万制造业员工中的6％。制造业中小企业的机器人密度为每万名员工6台。这大大低于欧洲114的平均水平，凸显了尚未充分解决的市场潜力。</li> <li>未来5年，我们预计工业机器人的前期单位成本将低于中国制造业年平均工资。因此，中国在全球制造业中的竞争优势将可能下降，推动全球生产向更便宜的市场转移。为了应对这一趋势，中国正在大力投资于机器人自动化。中国目前是世界上最大的工业机器人市场，占每年安装量的36%。</li></ul></li> <li><p>灵巧性和复杂性的进步使得工业机器人能够更深入地进入精密角色。</p></li> <li><p>2015年，机器人单位销售额达到了一个关键的拐点，标志着 &quot;高级 &quot;机器人的到来，也标志着一个新的增长阶段。</p></li></ul> <h3 id="_3-tip"><a href="#_3-tip" class="header-anchor">#</a> 3.Tip:</h3> <h4 id="elasticsearch-api"><a href="#elasticsearch-api" class="header-anchor">#</a> [ElasticSearch] API</h4> <p>什么是聚合分析:聚合分析有点类似于SQL语句中的那种group by、where age &gt; 20 and age &lt; 30、这种操作。常见的聚合分析就是根据某一个字段进行分组分析，要求这个字段是不能被分词的，如果被聚合的字段被分词，按照倒排索引的方式去索引的话，就不得不去扫描整个倒排索引(才可能将被聚合的字段找全，效率很低)。聚合分析是基于doc value的数据结果集进行操作的，这个doc value 其实就是正排索引，关于聚合分析有三个重要的概念：</p> <ul><li>bucket:特别是你去使用一下java、golang中的es相关的api，就会看到这个bucket关键字，bucket就是聚合操作得到的结果集。</li> <li>metric:metric就是对bucket进行分析，比如取最大值、最小值、平均值。</li> <li>下钻:下钻就是在现有的分好组的bucket继续分组，比如可以先按性别分组、下钻再按年龄分组。</li></ul> <p>15个聚合分析案例:
1、比如我们公司人很多，其中不泛有很多重名的人，现在我的需求是：我想知道我们公司中有多个人叫tom、多少个人叫jerry，也就是说，我想知道：重名的人分别有多少个。于是我们需要像下面这样根据名字聚合。聚合的结果中天然存在一个metric，它就是当前bucket的count，也就是我们想要的结果：</p> <div class="language-json extra-class"><pre class="language-json"><code>GET /your_index/your_type/_search
<span class="token punctuation">{</span>
  # 表示只要聚合的结果，而不要参与聚合的原始数据
  “size”<span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span>
  # 使用聚合时，天然存在一个metric，就是当前bucket的count
  <span class="token property">&quot;aggs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;group_by_name&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> # 自定义的名字
      <span class="token property">&quot;term&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;name&quot;</span> # 指定聚合的字段， 意思是 group by name
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span> 
GET /your_index/your_type/_search
<span class="token punctuation">{</span>
  “size”<span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span>
   # 使用聚合时，天然存在一个metric，就是当前bucket的count
  <span class="token property">&quot;aggs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;group_by_xxx&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> # 自定义的名字
     # 除了使用term还可以使用terms
     # trems允许你指定多个字段
     <span class="token property">&quot;terms&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
         # 指定聚合的字段， 意思是 group by v1、v2、v3
        <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token string">&quot;value1&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;value2&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;value3&quot;</span><span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>2、先搜索，再对搜索结果聚合。比如我想知道在所有的男生中的重名情况</p> <div class="language-json extra-class"><pre class="language-json"><code>GET /your_index/your_type/_search
<span class="token punctuation">{</span>
  # 先查询
  “query”<span class="token operator">:</span><span class="token punctuation">{</span>
      <span class="token property">&quot;term&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token property">&quot;gender&quot;</span><span class="token operator">:</span><span class="token string">&quot;man&quot;</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
   # 再聚合
  <span class="token property">&quot;aggs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;group_by_name&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;term&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;name&quot;</span> # 指定聚合的字段， 意思是 group by name
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>3、我想把重名的人分成一组，然后我想了解每组人的平均年龄。可以像下面这样干</p> <div class="language-json extra-class"><pre class="language-json"><code>GET /your_index/your_type/_search
<span class="token punctuation">{</span>
  <span class="token property">&quot;size&quot;</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span>
   # 聚合中嵌套聚合，意思是先 group by avg age，再 group by field1。
  <span class="token property">&quot;aggs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;group_by_name&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;terms&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;name&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
       # 在上面的name分组的结果之上再按照age聚合
      <span class="token property">&quot;aggs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;average_age&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          # 指定聚合函数为avg
          <span class="token property">&quot;avg&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;age&quot;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>4、我想了解我们公司不同年龄段：20岁～25岁有多少人、25岁～30岁有多少人、30岁～35岁、35岁～40岁有多少人，以及每个年龄段有多少女生，多少男生。</p> <div class="language-json extra-class"><pre class="language-json"><code>GET /your_index/your_type/_search
<span class="token punctuation">{</span>
   <span class="token property">&quot;size&quot;</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span>
   # 先按照年龄分组，在按照性别分组
   <span class="token property">&quot;aggs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;group_by_age&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;range&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;age&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;ranges&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
          <span class="token punctuation">{</span>
            <span class="token property">&quot;from&quot;</span><span class="token operator">:</span> <span class="token number">20</span><span class="token punctuation">,</span>
            <span class="token property">&quot;to&quot;</span><span class="token operator">:</span> <span class="token number">25</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span>
            <span class="token property">&quot;from&quot;</span><span class="token operator">:</span> <span class="token number">25</span><span class="token punctuation">,</span>
            <span class="token property">&quot;to&quot;</span><span class="token operator">:</span> <span class="token number">30</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span>
            <span class="token property">&quot;from&quot;</span><span class="token operator">:</span> <span class="token number">30</span><span class="token punctuation">,</span>
            <span class="token property">&quot;to&quot;</span><span class="token operator">:</span> <span class="token number">35</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span>
            <span class="token property">&quot;from&quot;</span><span class="token operator">:</span> <span class="token number">35</span><span class="token punctuation">,</span>
            <span class="token property">&quot;to&quot;</span><span class="token operator">:</span> <span class="token number">40</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">]</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;aggs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;group_by_gender&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;terms&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            # gender.keyword一般是ES自动为我们创建的类型
            # keyword类型的field不会分词、默认长度<span class="token number">256</span>字符
            # 这里大家初步了解有这个东西，知道怎么回事就行，下一篇文章扫盲
            <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;gender.keyword&quot;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
       <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>5、我想知道我们公司每个年龄段，每个性别的平均账户余额。</p> <div class="language-json extra-class"><pre class="language-json"><code>GET /your_index/your_type/_search
<span class="token punctuation">{</span>
  <span class="token property">&quot;size&quot;</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span>
   # 先按照年龄分组，在按照性别分组，再按照平均工资聚合
   # 最终的结果就得到了每个年龄段，每个性别的平均账户余额
   <span class="token property">&quot;aggs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;group_by_age&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;range&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;age&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;ranges&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
          <span class="token punctuation">{</span>
            <span class="token property">&quot;from&quot;</span><span class="token operator">:</span> <span class="token number">20</span><span class="token punctuation">,</span>
            <span class="token property">&quot;to&quot;</span><span class="token operator">:</span> <span class="token number">30</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">]</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;aggs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;group_by_gender&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;term&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;gender.keyword&quot;</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          # 在上一层根据gender聚合的基础上再基于avg balance聚合
          <span class="token property">&quot;aggs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;average_balance&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
              <span class="token property">&quot;avg&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;balance&quot;</span>
              <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>6、嵌套聚合，并且使用内部聚合的结果集</p> <div class="language-json extra-class"><pre class="language-json"><code>GET /your_index/your_type/_search
<span class="token punctuation">{</span>
  <span class="token property">&quot;size&quot;</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span>
   # 嵌套聚合，并且使用内部聚合的结果集
   <span class="token property">&quot;aggs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;group_by_state&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;term&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;state.keyword&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;order&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          # average_balance是下面内部聚合的结果集合，在此基础上做desc
          <span class="token property">&quot;average_balance&quot;</span><span class="token operator">:</span> <span class="token string">&quot;desc&quot;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      # 如下的agg会产出多个bucket如：
      # bucket1 =&gt; <span class="token punctuation">{</span>state=<span class="token number">1</span>，acg=xxx、min=xxx、max=xxx、sum=xxx<span class="token punctuation">}</span>
      # bucket2 =&gt; <span class="token punctuation">{</span>state=<span class="token number">2</span>，acg=xxx、min=xxx、max=xxx、sum=xxx<span class="token punctuation">}</span>
      <span class="token property">&quot;aggs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;average_balance&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;avg&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>  # avg 求平均值  metric
            <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;balance&quot;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
         <span class="token property">&quot;min_price&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;min&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>  # metric 求最小值
            <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;price&quot;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
         <span class="token property">&quot;max_price&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;max&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>  # metric 求最大值
            <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;price&quot;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
         <span class="token property">&quot;sum_price&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;sum&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>  # metric 计算总和
            <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;price&quot;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>8、除了前面说的按照值分组聚合，比如男、女，还可以使用histogram按区间聚合分析。</p> <div class="language-json extra-class"><pre class="language-json"><code>GET /your_index/your_type/_search
<span class="token punctuation">{</span>
  <span class="token property">&quot;size&quot;</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span>
  # histogram，类似于terms，同样会进行bucket分组操作。
  # 使用histogram需要执行一个field，比如下例中的age，表示按照age的范围进行分组聚合
  <span class="token property">&quot;aggs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> # 聚合中嵌套聚合
      <span class="token property">&quot;group_by_price&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;histogram&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                 <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;age&quot;</span><span class="token punctuation">,</span>
                  # interval为<span class="token number">10</span>，它会划分成这样 <span class="token number">0</span><span class="token number">-10</span>  <span class="token number">10</span><span class="token number">-20</span>  <span class="token number">20</span><span class="token number">-30</span> ...
                  # 那age为<span class="token number">21</span>的记录就会被分进<span class="token number">20</span><span class="token number">-30</span>的区间中
                 <span class="token property">&quot;interval&quot;</span><span class="token operator">:</span><span class="token number">10</span>
             <span class="token punctuation">}</span><span class="token punctuation">,</span>
       <span class="token property">&quot;aggs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> # 聚合中嵌套聚合
            <span class="token property">&quot;average_price&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
               <span class="token property">&quot;avg&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                  <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;price&quot;</span>
               <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
     <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>9、根据日期进行聚合</p> <div class="language-json extra-class"><pre class="language-json"><code>GET /your_index/your_type/_search
<span class="token punctuation">{</span>
  <span class="token property">&quot;size&quot;</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token property">&quot;aggs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
     <span class="token property">&quot;agg_by_time&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
          # 关键字
          <span class="token property">&quot;date_histogram&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token property">&quot;field&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;age&quot;</span><span class="token punctuation">,</span>
                # 间隔，一个月为一个跨度
                <span class="token property">&quot;interval&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;1M&quot;</span><span class="token punctuation">,</span>
                <span class="token property">&quot;format&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;yyyy-MM-dd&quot;</span><span class="token punctuation">,</span>
                # 即使这个区间中一条数据都没有，这个区间也要返回
                <span class="token property">&quot;min_doc_count&quot;</span><span class="token operator">:</span><span class="token number">0</span>
                # 指定区间
                “extended_bounds”<span class="token operator">:</span><span class="token punctuation">{</span>
                  <span class="token property">&quot;min&quot;</span><span class="token operator">:</span><span class="token string">&quot;2021-01-01&quot;</span><span class="token punctuation">,</span>
                  <span class="token property">&quot;max&quot;</span><span class="token operator">:</span><span class="token string">&quot;2021-01-01&quot;</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
# 补充
<span class="token property">&quot;interval&quot;</span><span class="token operator">:</span>“quarter”按照季度划分
</code></pre></div><p>10、filter aggregate 过滤、聚合。</p> <div class="language-json extra-class"><pre class="language-json"><code># Case1
# 如下例子：我想先过滤出年龄大于<span class="token number">20</span>的人，然后聚合他们的平均工资
GET /your_index/your_type/_search
<span class="token punctuation">{</span>
  <span class="token property">&quot;size&quot;</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token property">&quot;query&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
    <span class="token property">&quot;consitant_score&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
      # 这个filter会针对ES中全局的数据进行filter
      <span class="token property">&quot;filter&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token property">&quot;range&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;age&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;gte&quot;</span><span class="token operator">:</span><span class="token number">20</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;aggs&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
    <span class="token property">&quot;avg_salary&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
      <span class="token property">&quot;avg&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token property">&quot;field&quot;</span><span class="token operator">:</span><span class="token string">&quot;salary&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
# Case2
# bucket filter
POST /sales/_search
<span class="token punctuation">{</span>
    <span class="token property">&quot;aggs&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
        # T恤bucket的agg
        <span class="token property">&quot;agg_t_shirts&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;filter&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
              <span class="token property">&quot;term&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;t-shirt&quot;</span>
              <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token property">&quot;aggs&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token property">&quot;avg_price&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;avg&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;field&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;price&quot;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      # 毛衣bucket的agg
      <span class="token property">&quot;agg_sweater&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;filter&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
              <span class="token property">&quot;term&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;sweater&quot;</span>
              <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token property">&quot;aggs&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token property">&quot;avg_price&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;avg&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;field&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;price&quot;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>11、嵌套聚合-广度优先:说一个应用于场景: 我们检索电影的评论， 但是我们先按照演员分组聚合，再按照评论的数量进行聚合。且我们假设每个演员都出演了10部电影。
分析: 如果我们选择深度优先的话， ES在构建演员电影相关信息时，会顺道计算出电影下面评论数的信息，假如说有10万个演员的filter aggregate话， 10万*10=100万个电影 每个电影下又有很多影评，接着处理影评， 就这样内存中可能会存在几百万条数据，但是我们最终就需要50条，这种开销是很大的。广度优先的话，是我们先处理电影数，而不管电影的评论数的聚合情况，先从10万演员中干掉99990条数据，剩下10个演员再聚合。</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token property">&quot;aggs&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token property">&quot;target_actors&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
            <span class="token property">&quot;terms&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
                <span class="token property">&quot;field&quot;</span><span class="token operator">:</span><span class="token string">&quot;actors&quot;</span><span class="token punctuation">,</span>
                <span class="token property">&quot;size&quot;</span><span class="token operator">:</span><span class="token number">10</span><span class="token punctuation">,</span>
                <span class="token property">&quot;collect_mode&quot;</span><span class="token operator">:</span><span class="token string">&quot;breadth_first&quot;</span> # 广度优先
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>12、global aggregation 全局聚合，下面先使用query进行全文检索，然后进行聚合， 下面的聚合实际上是针对两个不同的结果进行聚合。</p> <ul><li>第一个聚合添加了global关键字，意思是ES中存在的所有doc进行聚合计算得出t-shirt的平均价格</li> <li>第二个聚合针对全文检索的结果进行聚合</li></ul> <div class="language-json extra-class"><pre class="language-json"><code>POST /sales/_search?size=<span class="token number">0</span>
<span class="token punctuation">{</span>
    <span class="token property">&quot;query&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
        # 全文检索 type = t-shirt的商品
        <span class="token property">&quot;match&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;t-shirt&quot;</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;aggs&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;all_products&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;global&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> # 表示让 all_products 对ES中所有数据进行聚合
            <span class="token property">&quot;aggs&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
                # 没有global关键字，表示针对全文检索的结果进行聚合
                <span class="token property">&quot;avg_price&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;avg&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;field&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;price&quot;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">&quot;t_shirts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;avg&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;field&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;price&quot;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>13、Cardinality Aggregate 基数聚合在ES中聚合时去重一般选用cardinality metric，它可以实现对每一个bucket中指定的field进行去重，最终得到去重后的count值。虽然她会存在5%左右的错误率，但是性能特别好</p> <div class="language-json extra-class"><pre class="language-json"><code>POST /sales/_search?size=<span class="token number">0</span>
<span class="token punctuation">{</span>
    <span class="token property">&quot;aggs&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
        # 先按照月份聚合得到不同月的bucket
        <span class="token property">&quot;agg_by_month&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;date_histogram&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
              <span class="token property">&quot;field&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;my_month&quot;</span><span class="token punctuation">,</span>
              <span class="token property">&quot;internal&quot;</span><span class="token operator">:</span><span class="token string">&quot;month&quot;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        # 在上一步得到的以月份为维护划分的bucket基础上，再按照品牌求基数去重。
        # 于是最终我们就得到了每个月、每种品牌的销售量。
        <span class="token property">&quot;aggs&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;dis_by_brand&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
              <span class="token property">&quot;cardinality&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
                 <span class="token property">&quot;field&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;brand&quot;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>对Cardinality Aggregate的性能优化， 添加 precision_threshold 优化准确率和内存的开销。还是下面的例子，如果将precision_threshold的值调整到100意思是：当品牌的总数量小于100时，去重的精准度为100%， 此时内存的占用情况为 100<em>8=800字节。加入我们将这个值调整为1000，意思是当品台的种类在1000个以内时，去重的精准度100%，内存的占用率为1000</em>8=80KB。官方给出的指标是：将precision_threshold设置为5时，错误率会被控制在5%以内。</p> <div class="language-json extra-class"><pre class="language-json"><code>POST /sales/_search?size=<span class="token number">0</span>
<span class="token punctuation">{</span>
    <span class="token property">&quot;aggs&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;type_count&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;cardinality&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span> # 关键字
                <span class="token property">&quot;field&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;brand&quot;</span>
                <span class="token property">&quot;precision_threshold&quot;</span><span class="token operator">:</span><span class="token number">100</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>进一步优化，Cardinality底层使用的算法是 HyperLogLog++。因为这个算法的底层会对所有的 unique value取hash值，利用这个hash值去近似的求distcint count， 因此我们可以在创建mapping时，将这个hash的求法设置好，添加doc时，一并计算出这个hash值，这样 HyperLogLog++ 就无需再计算hash值，而是直接使用。从而达到优化速度的效果。</p> <div class="language-json extra-class"><pre class="language-json"><code>PUT /index/
<span class="token punctuation">{</span>
    <span class="token property">&quot;mappings&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token property">&quot;my_type&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
            <span class="token property">&quot;properties&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
                <span class="token property">&quot;my_field&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
                    <span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;text&quot;</span><span class="token punctuation">,</span>
                    <span class="token property">&quot;fields&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
                        <span class="token property">&quot;hash&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
                            <span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;murmu3&quot;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>14、控制聚合的升降序:比如我想知道每种颜色item的平均价格，并且我希望按照价格的从小到大升序展示给我看。于是就像下面这样，先按照颜色聚合可以将相同颜色的item聚合成1组，在聚合的结果上再根据价格进行聚合。期望在最终的结果中，通过order控制按照价格聚合的分组中升序排序， 这算是个在下钻分析时的排序技巧。</p> <div class="language-json extra-class"><pre class="language-json"><code>GET /index/type/_search
<span class="token punctuation">{</span>
     <span class="token property">&quot;size&quot;</span><span class="token operator">:</span><span class="token number">0</span>，
     <span class="token property">&quot;aggs&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
         <span class="token property">&quot;group_by_color&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
             <span class="token property">&quot;term&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
                 <span class="token property">&quot;field&quot;</span><span class="token operator">:</span><span class="token string">&quot;color&quot;</span><span class="token punctuation">,</span>
                 <span class="token property">&quot;order&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span> #
                     <span class="token property">&quot;avg_price&quot;</span><span class="token operator">:</span><span class="token string">&quot;asc&quot;</span>
                 <span class="token punctuation">}</span>
             <span class="token punctuation">}</span>
         <span class="token punctuation">}</span><span class="token punctuation">,</span>
         <span class="token property">&quot;aggs&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
             # 在上一层按color聚合的基础上，再针对price进行聚合
             <span class="token property">&quot;avg_price&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
                 <span class="token property">&quot;avg&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
                     <span class="token property">&quot;field&quot;</span><span class="token operator">:</span><span class="token string">&quot;price&quot;</span>
                 <span class="token punctuation">}</span>
             <span class="token punctuation">}</span>
         <span class="token punctuation">}</span>
     <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>15、Percentiles Aggregation:计算百分比， 常用它计算：在200ms内成功访问网站的比率、在500ms内成功访问网站的比例、在1000ms内成功访问网站的比例，或者是销售价为1000元的商品占总销售量的比例、销售价为2000元的商品占总销售量的比例等等。示例: 针对doc中的 load_time字段， 计算出在不同百分比下面的 load_time_outliner情况。</p> <div class="language-json extra-class"><pre class="language-json"><code>GET latency/_search
<span class="token punctuation">{</span>
    <span class="token property">&quot;size&quot;</span><span class="token operator">:</span> <span class="token number">0</span>，
    <span class="token property">&quot;aggs&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;load_time_outlier&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
            # 关键字
            <span class="token property">&quot;percentiles&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token property">&quot;field&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;load_time&quot;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>响应解读：在百分之50的加载请求中，平均load_time的时间是在445.0。 在99%的请求中，平均加载时间980.1。</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
    ...
   <span class="token property">&quot;aggregations&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;load_time_outlier&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
         <span class="token property">&quot;values&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;1.0&quot;</span><span class="token operator">:</span> <span class="token number">9.9</span><span class="token punctuation">,</span>
            <span class="token property">&quot;5.0&quot;</span><span class="token operator">:</span> <span class="token number">29.500000000000004</span><span class="token punctuation">,</span>
            <span class="token property">&quot;25.0&quot;</span><span class="token operator">:</span> <span class="token number">167.5</span><span class="token punctuation">,</span>
            <span class="token property">&quot;50.0&quot;</span><span class="token operator">:</span> <span class="token number">445.0</span><span class="token punctuation">,</span>
            <span class="token property">&quot;75.0&quot;</span><span class="token operator">:</span> <span class="token number">722.5</span><span class="token punctuation">,</span>
            <span class="token property">&quot;95.0&quot;</span><span class="token operator">:</span> <span class="token number">940.5</span><span class="token punctuation">,</span>
            <span class="token property">&quot;99.0&quot;</span><span class="token operator">:</span> <span class="token number">980.1000000000001</span>
         <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>还可以自己指定百分比跨度间隔。</p> <div class="language-json extra-class"><pre class="language-json"><code>GET latency/_search
<span class="token punctuation">{</span>
    <span class="token property">&quot;size&quot;</span><span class="token operator">:</span> <span class="token number">0</span>，
    <span class="token property">&quot;aggs&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;load_time_outlier&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;percentiles&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token property">&quot;field&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;load_time&quot;</span><span class="token punctuation">,</span>
                <span class="token property">&quot;percents&quot;</span> <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">95</span><span class="token punctuation">,</span><span class="token number">99</span><span class="token punctuation">,</span><span class="token number">99.9</span><span class="token punctuation">]</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>优化: percentile底层使用的是 TDigest算法。用很多个节点执行百分比计算，近似估计，有误差，节点越多，越精准。可以设置compression的值， 默认是100 ， ES限制节点的最多是 compression*20 =2000个node去计算 ， 因为节点越多，性能就越差。一个节点占用 32字节， 1002032 = 64KB。</p> <div class="language-json extra-class"><pre class="language-json"><code>GET latency/_search
<span class="token punctuation">{</span>
    <span class="token property">&quot;size&quot;</span><span class="token operator">:</span> <span class="token number">0</span>，
    <span class="token property">&quot;aggs&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;load_time_outlier&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;percentiles&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token property">&quot;field&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;load_time&quot;</span><span class="token punctuation">,</span>
                <span class="token property">&quot;percents&quot;</span> <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">95</span><span class="token punctuation">,</span><span class="token number">99</span><span class="token punctuation">,</span><span class="token number">99.9</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token property">&quot;compression&quot;</span><span class="token operator">:</span><span class="token number">100</span> # 默认值<span class="token number">100</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_4-share"><a href="#_4-share" class="header-anchor">#</a> 4.Share:</h3> <p>https://blog.csdn.net/laoyang360/article/details/107133008
Elasticsearch 聚合数据结果不精确，怎么破？</p> <p>https://www.cnblogs.com/wangzhuxing/p/9581947.html
ES系列十四、ES聚合分析（聚合分析简介、指标聚合、桶聚合）</p> <p>https://www.jianshu.com/p/200d4abee8ec
Elasticsearch——聚合搜索</p> <p>https://mp.weixin.qq.com/s/m7PLNAJdN9dAzq_Nsv6Gqw
7种优化后的查询技巧</p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.65b0f24a.js" defer></script><script src="/assets/js/2.d6ca9a42.js" defer></script><script src="/assets/js/116.ef676fd0.js" defer></script>
  </body>
</html>
