<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>ARTS-week-21 | Oceantime&#39;s blog</title>
    <meta name="generator" content="VuePress 1.5.3">
    <link rel="icon" href="/logo.jpg">
    <meta name="description" content="Oceantime 个人网站">
    <link rel="preload" href="/assets/css/0.styles.abfd12c2.css" as="style"><link rel="preload" href="/assets/js/app.65b0f24a.js" as="script"><link rel="preload" href="/assets/js/2.d6ca9a42.js" as="script"><link rel="preload" href="/assets/js/103.4e1cd420.js" as="script"><link rel="prefetch" href="/assets/js/10.ad6941e4.js"><link rel="prefetch" href="/assets/js/100.8ade9f63.js"><link rel="prefetch" href="/assets/js/101.a15dfa49.js"><link rel="prefetch" href="/assets/js/102.761bd3ff.js"><link rel="prefetch" href="/assets/js/104.6cfd7216.js"><link rel="prefetch" href="/assets/js/105.e2d93a01.js"><link rel="prefetch" href="/assets/js/106.6151bc8f.js"><link rel="prefetch" href="/assets/js/107.ad872ea3.js"><link rel="prefetch" href="/assets/js/108.bc756e31.js"><link rel="prefetch" href="/assets/js/109.fe77c5ed.js"><link rel="prefetch" href="/assets/js/11.f05321e1.js"><link rel="prefetch" href="/assets/js/110.39bd8ea8.js"><link rel="prefetch" href="/assets/js/111.bd5d0a8b.js"><link rel="prefetch" href="/assets/js/112.66f93d20.js"><link rel="prefetch" href="/assets/js/113.e3f1b94f.js"><link rel="prefetch" href="/assets/js/114.6ca21a56.js"><link rel="prefetch" href="/assets/js/115.2369b994.js"><link rel="prefetch" href="/assets/js/116.ef676fd0.js"><link rel="prefetch" href="/assets/js/117.7762c22c.js"><link rel="prefetch" href="/assets/js/118.dc732d76.js"><link rel="prefetch" href="/assets/js/119.2b7f1a4d.js"><link rel="prefetch" href="/assets/js/12.b607cc9e.js"><link rel="prefetch" href="/assets/js/120.1b132ede.js"><link rel="prefetch" href="/assets/js/121.ff9a3172.js"><link rel="prefetch" href="/assets/js/122.2f47d49f.js"><link rel="prefetch" href="/assets/js/13.67af4ad6.js"><link rel="prefetch" href="/assets/js/14.c7827c0f.js"><link rel="prefetch" href="/assets/js/15.eedb1566.js"><link rel="prefetch" href="/assets/js/16.fe37cbf7.js"><link rel="prefetch" href="/assets/js/17.a38f0ae2.js"><link rel="prefetch" href="/assets/js/18.4990ee61.js"><link rel="prefetch" href="/assets/js/19.f4dbb6de.js"><link rel="prefetch" href="/assets/js/20.9ffd67c9.js"><link rel="prefetch" href="/assets/js/21.ac6e1d53.js"><link rel="prefetch" href="/assets/js/22.76b0e02e.js"><link rel="prefetch" href="/assets/js/23.ff3410dc.js"><link rel="prefetch" href="/assets/js/24.f76a6fea.js"><link rel="prefetch" href="/assets/js/25.0534f43c.js"><link rel="prefetch" href="/assets/js/26.c3725782.js"><link rel="prefetch" href="/assets/js/27.deb9c9f3.js"><link rel="prefetch" href="/assets/js/28.6f99ddc2.js"><link rel="prefetch" href="/assets/js/29.02cfc711.js"><link rel="prefetch" href="/assets/js/3.9f6270c9.js"><link rel="prefetch" href="/assets/js/30.ccabc2c3.js"><link rel="prefetch" href="/assets/js/31.b08f8990.js"><link rel="prefetch" href="/assets/js/32.ee62ba38.js"><link rel="prefetch" href="/assets/js/33.f7629f38.js"><link rel="prefetch" href="/assets/js/34.2853c933.js"><link rel="prefetch" href="/assets/js/35.97e611fd.js"><link rel="prefetch" href="/assets/js/36.fa3c8ed4.js"><link rel="prefetch" href="/assets/js/37.8ae8d904.js"><link rel="prefetch" href="/assets/js/38.05c35d7b.js"><link rel="prefetch" href="/assets/js/39.e5258c9e.js"><link rel="prefetch" href="/assets/js/4.ecc02e05.js"><link rel="prefetch" href="/assets/js/40.d668fe84.js"><link rel="prefetch" href="/assets/js/41.c09eb1d5.js"><link rel="prefetch" href="/assets/js/42.b940c3f3.js"><link rel="prefetch" href="/assets/js/43.5f4e8385.js"><link rel="prefetch" href="/assets/js/44.7231a1e4.js"><link rel="prefetch" href="/assets/js/45.585825f0.js"><link rel="prefetch" href="/assets/js/46.14ddc0e4.js"><link rel="prefetch" href="/assets/js/47.52d53fb0.js"><link rel="prefetch" href="/assets/js/48.01214996.js"><link rel="prefetch" href="/assets/js/49.a8e7ddc6.js"><link rel="prefetch" href="/assets/js/5.755ee6e4.js"><link rel="prefetch" href="/assets/js/50.8ef31d09.js"><link rel="prefetch" href="/assets/js/51.86c845e5.js"><link rel="prefetch" href="/assets/js/52.0d1a6570.js"><link rel="prefetch" href="/assets/js/53.0b2ca6b6.js"><link rel="prefetch" href="/assets/js/54.daa0b522.js"><link rel="prefetch" href="/assets/js/55.b7e6d8cc.js"><link rel="prefetch" href="/assets/js/56.67e22da8.js"><link rel="prefetch" href="/assets/js/57.1b8d87fd.js"><link rel="prefetch" href="/assets/js/58.4ef89df1.js"><link rel="prefetch" href="/assets/js/59.abdf0f5c.js"><link rel="prefetch" href="/assets/js/6.3df7280b.js"><link rel="prefetch" href="/assets/js/60.35f8805b.js"><link rel="prefetch" href="/assets/js/61.68fa7ebd.js"><link rel="prefetch" href="/assets/js/62.fd6b0085.js"><link rel="prefetch" href="/assets/js/63.af0dbde2.js"><link rel="prefetch" href="/assets/js/64.16a1ffec.js"><link rel="prefetch" href="/assets/js/65.af1a9908.js"><link rel="prefetch" href="/assets/js/66.0ab56108.js"><link rel="prefetch" href="/assets/js/67.7b28f376.js"><link rel="prefetch" href="/assets/js/68.be9ab4b2.js"><link rel="prefetch" href="/assets/js/69.c030abbd.js"><link rel="prefetch" href="/assets/js/7.3549904d.js"><link rel="prefetch" href="/assets/js/70.1469061c.js"><link rel="prefetch" href="/assets/js/71.4802b635.js"><link rel="prefetch" href="/assets/js/72.83cb541b.js"><link rel="prefetch" href="/assets/js/73.3ad064c7.js"><link rel="prefetch" href="/assets/js/74.00cd90be.js"><link rel="prefetch" href="/assets/js/75.cbf47e0f.js"><link rel="prefetch" href="/assets/js/76.44ccee9d.js"><link rel="prefetch" href="/assets/js/77.e9c38d7e.js"><link rel="prefetch" href="/assets/js/78.9122406c.js"><link rel="prefetch" href="/assets/js/79.5478a7f9.js"><link rel="prefetch" href="/assets/js/8.183e1cde.js"><link rel="prefetch" href="/assets/js/80.81f8b615.js"><link rel="prefetch" href="/assets/js/81.ceada5ea.js"><link rel="prefetch" href="/assets/js/82.6106ff2d.js"><link rel="prefetch" href="/assets/js/83.59665864.js"><link rel="prefetch" href="/assets/js/84.14e761a8.js"><link rel="prefetch" href="/assets/js/85.dd1f6fdb.js"><link rel="prefetch" href="/assets/js/86.c780faa6.js"><link rel="prefetch" href="/assets/js/87.b6a78c96.js"><link rel="prefetch" href="/assets/js/88.e6f83878.js"><link rel="prefetch" href="/assets/js/89.3b38af38.js"><link rel="prefetch" href="/assets/js/9.d9ab8dd1.js"><link rel="prefetch" href="/assets/js/90.64e54699.js"><link rel="prefetch" href="/assets/js/91.b0c97860.js"><link rel="prefetch" href="/assets/js/92.a49f1aa9.js"><link rel="prefetch" href="/assets/js/93.30383993.js"><link rel="prefetch" href="/assets/js/94.e5ff08c3.js"><link rel="prefetch" href="/assets/js/95.6ee9cb6c.js"><link rel="prefetch" href="/assets/js/96.829351f9.js"><link rel="prefetch" href="/assets/js/97.dcf9c2e9.js"><link rel="prefetch" href="/assets/js/98.58af886e.js"><link rel="prefetch" href="/assets/js/99.d137b7f6.js">
    <link rel="stylesheet" href="/assets/css/0.styles.abfd12c2.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Oceantime's blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/accumulate/" class="nav-link">
  前端基础
</a></div><div class="nav-item"><a href="/algorithm/" class="nav-link">
  算法题库
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/accumulate/" class="nav-link">
  前端基础
</a></div><div class="nav-item"><a href="/algorithm/" class="nav-link">
  算法题库
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>ARTS-week-21</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/2021/ARTS-week-21.html#arts-2019-左耳听风社群活动-每周完成一个-arts" class="sidebar-link">ARTS-2019 左耳听风社群活动--每周完成一个 ARTS</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/2021/ARTS-week-21.html#_1-algorithm" class="sidebar-link">1.Algorithm:</a></li><li class="sidebar-sub-header"><a href="/2021/ARTS-week-21.html#_2-review" class="sidebar-link">2.Review:</a></li><li class="sidebar-sub-header"><a href="/2021/ARTS-week-21.html#_3-tip" class="sidebar-link">3.Tip:</a></li><li class="sidebar-sub-header"><a href="/2021/ARTS-week-21.html#_4-share" class="sidebar-link">4.Share:</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="arts-2019-左耳听风社群活动-每周完成一个-arts"><a href="#arts-2019-左耳听风社群活动-每周完成一个-arts" class="header-anchor">#</a> ARTS-2019 左耳听风社群活动--每周完成一个 ARTS</h2> <p>1.Algorithm： 每周至少做一个 leetcode 的算法题
2.Review: 阅读并点评至少一篇英文技术文章
3.Tip: 学习至少一个技术技巧
4.Share: 分享一篇有观点和思考的技术文章</p> <h3 id="_1-algorithm"><a href="#_1-algorithm" class="header-anchor">#</a> 1.Algorithm:</h3> <p>有效的括号：https://leetcode-cn.com/submissions/detail/182263904/
丢失的数字：https://leetcode-cn.com/submissions/detail/182262146/</p> <h3 id="_2-review"><a href="#_2-review" class="header-anchor">#</a> 2.Review:</h3> <p>https://martinheinz.dev/blog/28
SQLAlchemy 高级功能</p> <h4 id="点评："><a href="#点评：" class="header-anchor">#</a> 点评：</h4> <p>如果您是 Python 开发人员并且您使用 SQL 数据库，那么 SQLAlchemy 很可能是您熟悉的库。它是强大而灵活的工具包，用于在 Python 中使用具有许多功能的 SQL。其中一些功能（如 ORM 和基本查询）是常识，但有很多功能您可能不知道并且绝对应该利用。因此，让我们看看如何利用混合属性、嵌套查询、表元数据、方言等！。</p> <ul><li>实际上有四类内存问题具有相似和重叠的特征，但原因和解决方案各不相同：
<ul><li>Performance (性能):通常与过多的对象创建和删除，垃圾收集的长时间延迟，过多的操作系统页面交换等相关联。</li> <li>Resource constraints (资源约束)：当可用内存很少或内存过于分散而无法分配大对象时 - 这可能是本机的，或者更常见的是与 Java  堆相关。</li> <li>Java heap leaks (java 堆泄漏):经典的内存泄漏，Java 对象在不释放的情况下不断创建。这通常是由潜在对象引用引起的。</li> <li>Native memory leaks (本机内存泄漏):与 Java 堆之外的任何不断增长的内存利用率相关联，例如由 JNI 代码，驱动程序甚至 JVM 分配。</li></ul></li></ul> <ol><li>列属性</li></ol> <ul><li>基于其他列创建映射属性是很普遍的-本质上是创建计算列。</li></ul> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">User</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">'user'</span>
    <span class="token builtin">id</span> <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    firstname <span class="token operator">=</span> Column<span class="token punctuation">(</span>String<span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    lastname <span class="token operator">=</span> Column<span class="token punctuation">(</span>String<span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    fullname <span class="token operator">=</span> column_property<span class="token punctuation">(</span>firstname <span class="token operator">+</span> <span class="token string">&quot; &quot;</span> <span class="token operator">+</span> lastname<span class="token punctuation">)</span>
</code></pre></div><ul><li>使用 SQL 表达式来创建这样的属性时它会更有用。</li></ul> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">CreditCard</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">'card'</span>
    <span class="token builtin">id</span> <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    user_id <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> ForeignKey<span class="token punctuation">(</span><span class="token string">'user.id'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nullable<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>


<span class="token keyword">class</span> <span class="token class-name">User</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">'user'</span>
    <span class="token builtin">id</span> <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    firstname <span class="token operator">=</span> Column<span class="token punctuation">(</span>String<span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    lastname <span class="token operator">=</span> Column<span class="token punctuation">(</span>String<span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    fullname <span class="token operator">=</span> column_property<span class="token punctuation">(</span>firstname <span class="token operator">+</span> <span class="token string">&quot; &quot;</span> <span class="token operator">+</span> lastname<span class="token punctuation">)</span>
    credit_card <span class="token operator">=</span> relationship<span class="token punctuation">(</span>CreditCard<span class="token punctuation">,</span> backref<span class="token operator">=</span><span class="token string">'report'</span><span class="token punctuation">)</span>
    has_credit_card <span class="token operator">=</span> column_property<span class="token punctuation">(</span>
        exists<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>where<span class="token punctuation">(</span>CreditCard<span class="token punctuation">.</span>user_id <span class="token operator">==</span> <span class="token builtin">id</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>

john <span class="token operator">=</span> User<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> firstname<span class="token operator">=</span><span class="token string">'John'</span><span class="token punctuation">,</span> lastname<span class="token operator">=</span><span class="token string">'Doe'</span><span class="token punctuation">)</span>
session<span class="token punctuation">.</span>add<span class="token punctuation">(</span>john<span class="token punctuation">)</span>
session<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>john<span class="token punctuation">.</span>has_credit_card<span class="token punctuation">)</span>
<span class="token comment"># False</span>
johns_card <span class="token operator">=</span> CreditCard<span class="token punctuation">(</span>user_id<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
session<span class="token punctuation">.</span>add<span class="token punctuation">(</span>johns_card<span class="token punctuation">)</span>
session<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>john<span class="token punctuation">.</span>has_credit_card<span class="token punctuation">)</span>
<span class="token comment"># True</span>
</code></pre></div><ol start="2"><li>混合属性</li></ol> <ul><li>在产生计算属性的意义上，它们类似于列属性。然而，混合属性从实例级别的 Python 表达式和类级别的 SQL 表达式生成值。</li></ul> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">Order</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">'order'</span>

    <span class="token builtin">id</span> <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    user_id <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> ForeignKey<span class="token punctuation">(</span><span class="token string">'user.id'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    state <span class="token operator">=</span> Column<span class="token punctuation">(</span>String<span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># Pending/Complete</span>


<span class="token keyword">class</span> <span class="token class-name">User</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">'user'</span>

    <span class="token builtin">id</span> <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    orders <span class="token operator">=</span> relationship<span class="token punctuation">(</span><span class="token string">&quot;Order&quot;</span><span class="token punctuation">)</span>
    name <span class="token operator">=</span> Column<span class="token punctuation">(</span>String<span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token decorator annotation punctuation">@hybrid_property</span>
    <span class="token keyword">def</span> <span class="token function">has_pending_orders</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token builtin">any</span><span class="token punctuation">(</span>order<span class="token punctuation">.</span>state <span class="token operator">==</span> <span class="token string">&quot;Pending&quot;</span> <span class="token keyword">for</span> order <span class="token keyword">in</span> self<span class="token punctuation">.</span>orders<span class="token punctuation">)</span>  <span class="token comment"># -&gt; produces value</span>

    <span class="token decorator annotation punctuation">@has_pending_orders<span class="token punctuation">.</span>expression</span>
    <span class="token keyword">def</span> <span class="token function">has_pending_orders</span><span class="token punctuation">(</span>cls<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>
            select<span class="token punctuation">(</span><span class="token punctuation">[</span>
                case<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">(</span>exists<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>where<span class="token punctuation">(</span>and_<span class="token punctuation">(</span>
                    Order<span class="token punctuation">.</span>user_id <span class="token operator">==</span> cls<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span>
                    Order<span class="token punctuation">.</span>state <span class="token operator">==</span> <span class="token string">&quot;Pending&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>correlate<span class="token punctuation">(</span>cls<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> else_<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
                <span class="token punctuation">)</span><span class="token punctuation">.</span>label<span class="token punctuation">(</span><span class="token string">&quot;has_pending_order&quot;</span><span class="token punctuation">)</span>
            <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>label<span class="token punctuation">(</span><span class="token string">&quot;number_of_pending_orders&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span>  <span class="token comment"># -&gt; produces SQL expression</span>

user <span class="token operator">=</span> User<span class="token punctuation">(</span>
    name<span class="token operator">=</span><span class="token string">&quot;John&quot;</span><span class="token punctuation">,</span>
    orders<span class="token operator">=</span><span class="token punctuation">[</span>
        Order<span class="token punctuation">(</span>state<span class="token operator">=</span><span class="token string">&quot;Complete&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        Order<span class="token punctuation">(</span>state<span class="token operator">=</span><span class="token string">&quot;Pending&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>has_pending_orders<span class="token punctuation">)</span>  <span class="token comment"># evaluate as Python expression</span>
<span class="token comment"># True</span>
user <span class="token operator">=</span> session<span class="token punctuation">.</span>query<span class="token punctuation">(</span>User<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>User<span class="token punctuation">.</span>has_pending_orders<span class="token punctuation">)</span><span class="token punctuation">.</span>scalar<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># evaluate as SQL expression (Filter)</span>
<span class="token comment"># SELECT * FROM user</span>
<span class="token comment"># WHERE (</span>
<span class="token comment">#   SELECT CASE WHEN (EXISTS (</span>
<span class="token comment">#       SELECT *</span>
<span class="token comment">#       FROM order</span>
<span class="token comment">#       WHERE order.user_id = user.id AND order.state = 'Pending'</span>
<span class="token comment">#   )) THEN 1 ELSE 0 END AS has_pending_order)</span>

</code></pre></div><ul><li>为了展示 的功能hybrid_property，我们实现了User和之间的简单关系Order，其中每个用户都有订单列表，.state在这种情况下，要么是Pending要么是Complete。现在，如果我们想知道用户是否有任何Pending订单，我们需要考虑两种情况 - 如果我们正在处理已经加载到 Python 对象中的行，那么我们可以只使用 Python 表达式并生成 Python 值 ( has_pending_orders(self)) . 另一方面，如果我们直接从数据库查询这些信息，我们不能使用 Python 表达式，因为数据库引擎不会理解它。因此，对于这种情况 ( has_pending_orders(cls))，我们编写了可以针对数据库运行的 SQL 表达式。</li> <li>附带说明 - 如果您的表达式对于 Python 和 SQL 评估都相同，那么您可以省略用装饰的第二个函数.expression，SQLAlchemy 将在这两种情况下使用第一个函数。</li></ul> <ol start="3"><li>混合</li></ol> <ul><li>Mixin不仅是 SQLAlchemy 特有的，而且它们在与 ORM 模型结合使用时特别有用。很多时候你可能会遇到这样的情况，你有多个类（模型）需要相同的属性或相同的classmethod. 一个这样的例子是User下面的模型：</li></ul> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">MixinAsDict</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">as_dict</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span>c<span class="token punctuation">.</span>name<span class="token punctuation">:</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> c<span class="token punctuation">.</span>name<span class="token punctuation">)</span> <span class="token keyword">for</span> c <span class="token keyword">in</span> self<span class="token punctuation">.</span>__table__<span class="token punctuation">.</span>columns<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">MixinGetByUsername</span><span class="token punctuation">:</span>
    username <span class="token operator">=</span> Column<span class="token punctuation">(</span>String<span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">,</span> unique<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> nullable<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

    <span class="token decorator annotation punctuation">@classmethod</span>
    <span class="token keyword">def</span> <span class="token function">get_by_username</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> username<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> session<span class="token punctuation">.</span>query<span class="token punctuation">(</span>cls<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>cls<span class="token punctuation">.</span>username <span class="token operator">==</span> username<span class="token punctuation">)</span><span class="token punctuation">.</span>first<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">class</span> <span class="token class-name">User</span><span class="token punctuation">(</span>MixinAsDict<span class="token punctuation">,</span> MixinGetByUsername<span class="token punctuation">,</span> Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">'user'</span>
    <span class="token builtin">id</span> <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

user <span class="token operator">=</span> User<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> username<span class="token operator">=</span><span class="token string">&quot;John&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>as_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment"># {'username': 'John', 'id': 1}</span>
session<span class="token punctuation">.</span>add<span class="token punctuation">(</span>user<span class="token punctuation">)</span>
session<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>

john <span class="token operator">=</span> User<span class="token punctuation">.</span>get_by_username<span class="token punctuation">(</span><span class="token string">&quot;John&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;User: </span><span class="token interpolation"><span class="token punctuation">{</span>john<span class="token punctuation">.</span>username<span class="token punctuation">}</span></span><span class="token string"> with ID: </span><span class="token interpolation"><span class="token punctuation">{</span>john<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span>
<span class="token comment"># User: John with ID: 1</span>
</code></pre></div><ul><li>在这个例子中，我们有 2 个Mixin类，User模型继承自这些类。首先 -MixinAsDict提供方法as_dict(self)，可用于获取dict模型的表示。另一个MixinGetByUsername提供username列和静态方法，用于按用户名查询用户。将这些函数定义为Mixins允许我们使它们可重用并将它们添加到其他模型中，而无需在任何地方复制粘贴相同的代码。</li></ul> <ol start="4"><li>使用元数据</li></ol> <ul><li>有时您可能需要访问表列名，检查表上的约束或检查列是否可以为空。所有这些都可以通过MetaData()类来完成：</li></ul> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">Address</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">'address'</span>
    <span class="token builtin">id</span> <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    user_id <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> ForeignKey<span class="token punctuation">(</span><span class="token string">'user.id'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nullable<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    street <span class="token operator">=</span> Column<span class="token punctuation">(</span>String<span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">User</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">'user'</span>
    <span class="token builtin">id</span> <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    firstname <span class="token operator">=</span> Column<span class="token punctuation">(</span>String<span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    lastname <span class="token operator">=</span> Column<span class="token punctuation">(</span>String<span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    address <span class="token operator">=</span> relationship<span class="token punctuation">(</span>Address<span class="token punctuation">,</span> backref<span class="token operator">=</span><span class="token string">'report'</span><span class="token punctuation">)</span>

Base<span class="token punctuation">.</span>metadata<span class="token punctuation">.</span>create_all<span class="token punctuation">(</span>engine<span class="token punctuation">)</span>

meta <span class="token operator">=</span> Base<span class="token punctuation">.</span>metadata  <span class="token comment"># Metadata()</span>

<span class="token keyword">for</span> t <span class="token keyword">in</span> meta<span class="token punctuation">.</span>sorted_tables<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>name<span class="token punctuation">)</span>

<span class="token comment"># user</span>
<span class="token comment"># address</span>

<span class="token keyword">print</span><span class="token punctuation">(</span>meta<span class="token punctuation">.</span>tables<span class="token punctuation">[</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">]</span><span class="token punctuation">.</span>c<span class="token punctuation">)</span>
<span class="token comment"># ['user.id', 'user.firstname', 'user.lastname']</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>meta<span class="token punctuation">.</span>tables<span class="token punctuation">[</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">]</span><span class="token punctuation">.</span>c<span class="token punctuation">[</span><span class="token string">&quot;lastname&quot;</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">type</span><span class="token punctuation">)</span>
<span class="token comment"># VARCHAR(50)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>meta<span class="token punctuation">.</span>tables<span class="token punctuation">[</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">]</span><span class="token punctuation">.</span>c<span class="token punctuation">[</span><span class="token string">&quot;lastname&quot;</span><span class="token punctuation">]</span><span class="token punctuation">.</span>nullable<span class="token punctuation">)</span>
<span class="token comment"># True</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>meta<span class="token punctuation">.</span>tables<span class="token punctuation">[</span><span class="token string">&quot;address&quot;</span><span class="token punctuation">]</span><span class="token punctuation">.</span>foreign_keys<span class="token punctuation">)</span>
<span class="token comment"># {ForeignKey('user.id')}</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>meta<span class="token punctuation">.</span>tables<span class="token punctuation">[</span><span class="token string">&quot;address&quot;</span><span class="token punctuation">]</span><span class="token punctuation">.</span>primary_key<span class="token punctuation">)</span>
<span class="token comment"># PrimaryKeyConstraint(Column('id', Integer(), table=&lt;address&gt;, primary_key=True, nullable=False))</span>
</code></pre></div><ul><li>这里的重要部分是print代码片段底部的语句。它们中的每一个都演示了您可以通过元数据对象访问的一些内容。这包括表名、列名、列类型、外键和主键以及其他约束。</li></ul> <ol start="5"><li>配置表</li></ol> <ul><li>您的某些数据库表可能需要更广泛的初始设置。例如 - 您可能希望包含一些检查约束、索引或指定不同的架构：。</li></ul> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">Card</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">'card'</span>
    __table_args__ <span class="token operator">=</span> <span class="token punctuation">(</span>
        CheckConstraint<span class="token punctuation">(</span><span class="token string">&quot;created &lt; valid_until&quot;</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">&quot;validity_check&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        CheckConstraint<span class="token punctuation">(</span><span class="token string">&quot;card_type ~* '^(debit|credit){1}$''&quot;</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">&quot;type_check&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        Index<span class="token punctuation">(</span><span class="token string">&quot;index&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        ForeignKeyConstraint<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'id'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'remote_table.id'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token string">'extend_existing'</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">,</span> <span class="token string">&quot;schema&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;default&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>

    <span class="token builtin">id</span> <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    created <span class="token operator">=</span> Column<span class="token punctuation">(</span>Date<span class="token punctuation">)</span>
    valid_until <span class="token operator">=</span> Column<span class="token punctuation">(</span>Date<span class="token punctuation">)</span>
    card_type <span class="token operator">=</span> Column<span class="token punctuation">(</span>String<span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><ul><li>所有这些都可以使用__table_args__class 属性进行配置。在这里，我们设置了 2 个检查约束、1 个 ID 列索引和外键约束。我们还开启了自动表扩展，这意味着如果我们在创建该表后向该表添加列，那么它会被自动添加。最后，我们还指定该表属于哪个模式。</li></ul> <ol start="6"><li>使用自定义方言</li></ol> <ul><li>每个数据库引擎都有一些您可能想要使用的自定义功能。对于我 - 作为 PostgreSQL 用户 - 我想使用 PostgreSQL 拥有的一些自定义列类型。那么如何将它们与 SQLAlchemy 一起使用呢？</li></ul> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> uuid <span class="token keyword">import</span> uuid4
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>dialects<span class="token punctuation">.</span>postgresql <span class="token keyword">import</span> UUID<span class="token punctuation">,</span> INT4RANGE<span class="token punctuation">,</span> NUMRANGE<span class="token punctuation">,</span> JSON

engine <span class="token operator">=</span> create_engine<span class="token punctuation">(</span><span class="token string">'postgresql+psycopg2://postgres:postgres@localhost/testdb'</span><span class="token punctuation">,</span> echo<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">Example</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">'example'</span>

    <span class="token builtin">id</span> <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    uuid <span class="token operator">=</span> Column<span class="token punctuation">(</span>UUID<span class="token punctuation">(</span>as_uuid<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span> unique<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> nullable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> default<span class="token operator">=</span>uuid4<span class="token punctuation">)</span>
    int_range <span class="token operator">=</span> Column<span class="token punctuation">(</span>INT4RANGE<span class="token punctuation">)</span>
    num_range <span class="token operator">=</span> Column<span class="token punctuation">(</span>NUMRANGE<span class="token punctuation">)</span>
    pg_json <span class="token operator">=</span> Column<span class="token punctuation">(</span>JSON<span class="token punctuation">)</span>
    pg_array <span class="token operator">=</span> Column<span class="token punctuation">(</span>postgresql<span class="token punctuation">.</span>ARRAY<span class="token punctuation">(</span>Integer<span class="token punctuation">)</span><span class="token punctuation">,</span> server_default<span class="token operator">=</span><span class="token string">'{}'</span><span class="token punctuation">)</span>


<span class="token keyword">from</span> psycopg2<span class="token punctuation">.</span>extras <span class="token keyword">import</span> NumericRange

example <span class="token operator">=</span> Example<span class="token punctuation">(</span>
    uuid<span class="token operator">=</span>uuid4<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    int_range<span class="token operator">=</span>NumericRange<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    num_range<span class="token operator">=</span>NumericRange<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    pg_json<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">&quot;key&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;value&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    pg_array<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">24</span><span class="token punctuation">,</span> <span class="token number">74</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span>session<span class="token punctuation">.</span>query<span class="token punctuation">(</span>Example<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>Example<span class="token punctuation">.</span>pg_array<span class="token punctuation">.</span>contains<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>scalar<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment"># SELECT * FROM example WHERE example.pg_array @&gt; [5]</span>

<span class="token comment"># &lt;__main__.Example object at 0x7f2d600a4070&gt;  # Object we previously inserted</span>

<span class="token keyword">print</span><span class="token punctuation">(</span>session<span class="token punctuation">.</span>query<span class="token punctuation">(</span>Example<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>Example<span class="token punctuation">.</span>pg_json<span class="token punctuation">[</span><span class="token string">&quot;key&quot;</span><span class="token punctuation">]</span><span class="token punctuation">.</span>astext <span class="token operator">==</span> <span class="token string">&quot;value&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>scalar<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment"># SELECT *</span>
<span class="token comment"># FROM example</span>
<span class="token comment"># WHERE (example.pg_json -&gt;&gt; 'key' = 'value'</span>

<span class="token comment"># &lt;__main__.Example object at 0x7f04dee05070&gt;  # Object we previously inserted</span>
</code></pre></div><ul><li>以上示出了一个代码Example具有PostgreSQL表UUID，INT4RANGE，NUMRANGE，JSON和ARRAY列。所有这些以及更多内容都可以从sqlalchemy.dialects.postgresql. 创建包含这些类型值的行是不言自明的。但是，在查询它们时，您将需要使用方言和类型特定的比较器，如上所示，以及 PostgreSQLARRAY类型和.contains比较器。对于像JSON您这样的其他类型，只需将它们作为文本进行比较（使用.astext）。</li></ul> <ol start="7"><li>使用 PostgreSQL 进行全文搜索
而关于 PostgreSQL 特性的话题。使用tsqeury和进行全文搜索tsvector怎么样？我们也可以使用 SQLAchemy 做到这一点：</li></ol> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">MixinSearch</span><span class="token punctuation">:</span>

    <span class="token decorator annotation punctuation">@classmethod</span>
    <span class="token keyword">def</span> <span class="token function">fulltext_search</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> session<span class="token punctuation">,</span> search_string<span class="token punctuation">,</span> field<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> session<span class="token punctuation">.</span>query<span class="token punctuation">(</span>cls<span class="token punctuation">)</span><span class="token punctuation">.</span> \
            <span class="token builtin">filter</span><span class="token punctuation">(</span>func<span class="token punctuation">.</span>to_tsvector<span class="token punctuation">(</span><span class="token string">'english'</span><span class="token punctuation">,</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> field<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>match<span class="token punctuation">(</span>search_string<span class="token punctuation">,</span> postgresql_regconfig<span class="token operator">=</span><span class="token string">'english'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">Book</span><span class="token punctuation">(</span>MixinSearch<span class="token punctuation">,</span> Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">'book'</span>

    <span class="token builtin">id</span> <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    title <span class="token operator">=</span> Column<span class="token punctuation">(</span>String<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    body <span class="token operator">=</span> Column<span class="token punctuation">(</span>Text<span class="token punctuation">)</span>

book <span class="token operator">=</span> Book<span class="token punctuation">(</span>
    title<span class="token operator">=</span><span class="token string">&quot;The Catcher in the Rye&quot;</span><span class="token punctuation">,</span>
    body<span class="token operator">=</span><span class="token triple-quoted-string string">&quot;&quot;&quot;First page of the book...&quot;&quot;&quot;</span>
<span class="token punctuation">)</span>

success <span class="token operator">=</span> Book<span class="token punctuation">.</span>fulltext_search<span class="token punctuation">(</span>session<span class="token punctuation">,</span> <span class="token string">&quot;David &amp; Copperfield&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;body&quot;</span><span class="token punctuation">)</span>
<span class="token comment"># SELECT *</span>
<span class="token comment"># FROM book</span>
<span class="token comment"># WHERE to_tsvector(english, book.body) @@ to_tsquery('english','David &amp; Copperfield')</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>success<span class="token punctuation">)</span>
<span class="token comment"># [&lt;__main__.Book object at 0x7fdac5e44520&gt;]</span>
fail <span class="token operator">=</span> Book<span class="token punctuation">.</span>fulltext_search<span class="token punctuation">(</span>session<span class="token punctuation">,</span> <span class="token string">&quot;cat &amp; dog&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;body&quot;</span><span class="token punctuation">)</span>
<span class="token comment"># SELECT *</span>
<span class="token comment"># FROM book</span>
<span class="token comment"># WHERE to_tsvector(english, book.body) @@ to_tsquery('english', 'cat &amp; dog')</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>fail<span class="token punctuation">)</span>
<span class="token comment"># []</span>
</code></pre></div><ul><li>我们再次为全文搜索创建Mixin类，因为这是许多模型可以使用的东西。这个Mixin有一个静态方法，它使用搜索字符串和列在 ( field) 中搜索。为了进行我们使用的实际搜索func.totsvector，我们将语言和引用传递给表列。在这一点上，我们将调用链接到.match函数，它实际上是to_tsqueryPostgreSQL 中的调用，我们将搜索字符串和搜索配置作为参数提供给它。从生成的 SQL 中我们可以看到 Python 代码确实生成了正确的 SQL 查询。</li></ul> <ol start="8"><li>跟踪行的最后更新</li></ol> <ul><li>创建created_at或创建updated_at列是很常见的做法。这可以使用 SQLAlchemy 非常简单地完成：</li></ul> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">Example</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">'example'</span>

    <span class="token builtin">id</span> <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    updated_at <span class="token operator">=</span> Column<span class="token punctuation">(</span>DateTime<span class="token punctuation">(</span>timezone<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span> server_default<span class="token operator">=</span>func<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> onupdate<span class="token operator">=</span>func<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    data <span class="token operator">=</span> Column<span class="token punctuation">(</span>String<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span>


example <span class="token operator">=</span> Example<span class="token punctuation">(</span>
    data<span class="token operator">=</span><span class="token string">&quot;Some data...&quot;</span>
<span class="token punctuation">)</span>

row <span class="token operator">=</span> session<span class="token punctuation">.</span>query<span class="token punctuation">(</span>Example<span class="token punctuation">)</span><span class="token punctuation">.</span>scalar<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>row<span class="token punctuation">.</span>updated_at<span class="token punctuation">)</span>
<span class="token comment"># 10:13:14.001813+00:00</span>

time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
row<span class="token punctuation">.</span>data <span class="token operator">=</span> <span class="token string">&quot;Some new data...&quot;</span>
session<span class="token punctuation">.</span>add<span class="token punctuation">(</span>row<span class="token punctuation">)</span>
session<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>

row <span class="token operator">=</span> session<span class="token punctuation">.</span>query<span class="token punctuation">(</span>Example<span class="token punctuation">)</span><span class="token punctuation">.</span>scalar<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>row<span class="token punctuation">.</span>updated_at<span class="token punctuation">)</span>
<span class="token comment"># 10:13:16.590945+00:00</span>
</code></pre></div><ul><li>因为updated_at您只需要设置onupdate为func.now()which 将使得每次更新行时，此列将设置为当前时间戳。至于created_at列，您可以省略onupdate参数，而是使用server_defaultwhich 设置创建行时调用的函数。</li></ul> <ol start="9"><li>自引用表</li></ol> <ul><li>在数据库中具有递归/自我参照关系的情况并不少见-无论是经理人-&gt;雇员关系，树状结构还是某些物化路径。这个技巧展示了如何使用 SQLAlchemy 设置这种关系：</li></ul> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">Node</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">'node'</span>
    <span class="token builtin">id</span> <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    parent_id <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> ForeignKey<span class="token punctuation">(</span><span class="token string">'node.id'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    data <span class="token operator">=</span> Column<span class="token punctuation">(</span>String<span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    children <span class="token operator">=</span> relationship<span class="token punctuation">(</span><span class="token string">&quot;Node&quot;</span><span class="token punctuation">,</span>
                            backref<span class="token operator">=</span>backref<span class="token punctuation">(</span><span class="token string">'parent'</span><span class="token punctuation">,</span> remote_side<span class="token operator">=</span><span class="token punctuation">[</span><span class="token builtin">id</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                            <span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">__str__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> level<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        ret <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f&quot;</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token string">'    '</span> <span class="token operator">*</span> level<span class="token punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token builtin">repr</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string"> \n&quot;</span></span>
        <span class="token keyword">for</span> child <span class="token keyword">in</span> self<span class="token punctuation">.</span>children<span class="token punctuation">:</span>
            ret <span class="token operator">+=</span> child<span class="token punctuation">.</span>__str__<span class="token punctuation">(</span>level <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> ret

    <span class="token keyword">def</span> <span class="token function">__repr__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>data


node <span class="token operator">=</span> Node<span class="token punctuation">(</span>
    data<span class="token operator">=</span><span class="token string">&quot;Node 1&quot;</span><span class="token punctuation">,</span>
    children<span class="token operator">=</span><span class="token punctuation">[</span>
        Node<span class="token punctuation">(</span>data<span class="token operator">=</span><span class="token string">&quot;Node 2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        Node<span class="token punctuation">(</span>
            data<span class="token operator">=</span><span class="token string">&quot;Node 3&quot;</span><span class="token punctuation">,</span>
            children<span class="token operator">=</span><span class="token punctuation">[</span>
                Node<span class="token punctuation">(</span>data<span class="token operator">=</span><span class="token string">&quot;Node 5&quot;</span><span class="token punctuation">)</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
        Node<span class="token punctuation">(</span>data<span class="token operator">=</span><span class="token string">&quot;Node 4&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">)</span>
rows <span class="token operator">=</span> session<span class="token punctuation">.</span>query<span class="token punctuation">(</span>Node<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>rows<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment"># 'Node 1'</span>
<span class="token comment">#     'Node 2'</span>
<span class="token comment">#     'Node 3'</span>
<span class="token comment">#         'Node 5'</span>
<span class="token comment">#     'Node 4'</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>rows<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment"># 'Node 3'</span>
<span class="token comment">#     'Node 5'</span>
</code></pre></div><ul><li>对于这个例子，我们使用使用Node记录创建的树结构。每个节点都有 some data，对其父节点及其子节点列表的引用。作为一种方便的方法，我们还包括__str__并__repr__帮助我们更好地可视化树。如果您对正常的一对多关系没问题，那么您可以像处理任何非自引用关系那样进行操作。为了使其适用于双向关系，您还需要包括backrefwith，remote_side=[id]如上所示。</li></ul> <ol start="10"><li>使用 Flask 绑定多个数据库</li></ol> <ul><li>最后一个适用于所有Flask用户。如果您需要连接到多个数据库 - 例如因为多个地理区域或多个数据源 - 那么您可以使用SQLALCHEMY_BINDS指定额外的数据库绑定：</li></ul> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment"># Config</span>
SQLALCHEMY_DATABASE_URI <span class="token operator">=</span> <span class="token string">'postgres+psycopg2://localhost/emea'</span>  <span class="token comment"># Europe, the Middle East and Africa</span>
SQLALCHEMY_BINDS <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">'emea'</span><span class="token punctuation">:</span>     <span class="token string">'postgres+psycopg2://localhost/emea'</span><span class="token punctuation">,</span>  <span class="token comment"># Europe, the Middle East and Africa</span>
    <span class="token string">'ap'</span><span class="token punctuation">:</span>       <span class="token string">'mysqldb://localhost/ap'</span><span class="token punctuation">,</span>              <span class="token comment"># Asia Pacific</span>
    <span class="token string">'la'</span><span class="token punctuation">:</span>       <span class="token string">'postgres+psycopg2://localhost/la'</span><span class="token punctuation">,</span>    <span class="token comment"># Latin America</span>
<span class="token punctuation">}</span>

<span class="token comment"># Models</span>
<span class="token keyword">class</span> <span class="token class-name">User</span><span class="token punctuation">(</span>db<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __bind_key__ <span class="token operator">=</span> <span class="token string">'emea'</span>  <span class="token comment"># Declare to which database the model belongs to</span>
    <span class="token builtin">id</span> <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>Integer<span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    username <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>String<span class="token punctuation">(</span><span class="token number">80</span><span class="token punctuation">)</span><span class="token punctuation">,</span> unique<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
</code></pre></div><ul><li>在上面的代码片段中，我们通过设置SQLALCHEMY_DATABASE_URI和替代绑定来配置默认数据库SQLALCHEMY_BINDS。通过此配置，我们将可以使用上述所有数据库。接下来，我们设置__bind_key__一个表来引用其中一个绑定，这样每当我们与这个特定的表交互时，SQLAlchemy 就会知道要连接到哪个数据库。但是，如果您需要连接到具有相同表/模式的多个数据库，您可以使用多个引擎和会话 - 每个数据库一个，并根据需要在它们之间切换，如下所示：</li></ul> <div class="language-python extra-class"><pre class="language-python"><code>engine_emea   <span class="token operator">=</span> create_engine<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
engine_ap     <span class="token operator">=</span> create_engine<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
engine_la     <span class="token operator">=</span> create_engine<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>

session_emea  <span class="token operator">=</span> sessionmaker<span class="token punctuation">(</span>bind<span class="token operator">=</span>engine_emea<span class="token punctuation">)</span>
session_ap    <span class="token operator">=</span> sessionmaker<span class="token punctuation">(</span>bind<span class="token operator">=</span>engine_ap<span class="token punctuation">)</span>
session_la    <span class="token operator">=</span> sessionmaker<span class="token punctuation">(</span>bind<span class="token operator">=</span>engine_la<span class="token punctuation">)</span>
</code></pre></div><ol start="11"><li>结论
希望这里显示的这些提示和技巧中至少有一些对您有用，并且在您下次需要使用 SQLAlchemy 时会让您的生活更轻松一些。这篇文章绝对不是你可以用 SQLAlchemy 做的所有很酷的事情的详尽列表，你可以通过滚动浏览https://docs.sqlalchemy.org/en/13/core/index.html找到一堆有用的东西。</li></ol> <h3 id="_3-tip"><a href="#_3-tip" class="header-anchor">#</a> 3.Tip:</h3> <h4 id="java-python-aes-加解密互转"><a href="#java-python-aes-加解密互转" class="header-anchor">#</a> java python aes 加解密互转</h4> <p>1.1 Java Code(Base64 from org.apache.commons.codec.binary.Base64)：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">encrypt</span><span class="token punctuation">(</span><span class="token class-name">String</span> secretKey<span class="token punctuation">,</span> <span class="token class-name">String</span> salt<span class="token punctuation">,</span> <span class="token class-name">String</span> value<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">Cipher</span> cipher <span class="token operator">=</span> <span class="token function">initCipher</span><span class="token punctuation">(</span>secretKey<span class="token punctuation">,</span> salt<span class="token punctuation">,</span> <span class="token class-name">Cipher</span><span class="token punctuation">.</span>ENCRYPT_MODE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> encrypted <span class="token operator">=</span> cipher<span class="token punctuation">.</span><span class="token function">doFinal</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">Base64</span><span class="token punctuation">.</span><span class="token function">encodeBase64String</span><span class="token punctuation">(</span>encrypted<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">decrypt</span><span class="token punctuation">(</span><span class="token class-name">String</span> secretKey<span class="token punctuation">,</span> <span class="token class-name">String</span> salt<span class="token punctuation">,</span> <span class="token class-name">String</span> encrypted<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">Cipher</span> cipher <span class="token operator">=</span> <span class="token function">initCipher</span><span class="token punctuation">(</span>secretKey<span class="token punctuation">,</span> salt<span class="token punctuation">,</span> <span class="token class-name">Cipher</span><span class="token punctuation">.</span>DECRYPT_MODE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> original <span class="token operator">=</span> cipher<span class="token punctuation">.</span><span class="token function">doFinal</span><span class="token punctuation">(</span><span class="token class-name">Base64</span><span class="token punctuation">.</span><span class="token function">decodeBase64</span><span class="token punctuation">(</span>encrypted<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>original<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Cipher</span> <span class="token function">initCipher</span><span class="token punctuation">(</span><span class="token class-name">String</span> secretKey<span class="token punctuation">,</span> <span class="token class-name">String</span> salt<span class="token punctuation">,</span> <span class="token keyword">int</span> mode<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>

        <span class="token class-name">SecretKeyFactory</span> factory <span class="token operator">=</span> <span class="token class-name">SecretKeyFactory</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token string">&quot;PBKDF2WithHmacSHA256&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">KeySpec</span> spec <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PBEKeySpec</span><span class="token punctuation">(</span>secretKey<span class="token punctuation">.</span><span class="token function">toCharArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> salt<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">65536</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">SecretKey</span> tmp <span class="token operator">=</span> factory<span class="token punctuation">.</span><span class="token function">generateSecret</span><span class="token punctuation">(</span>spec<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">SecretKeySpec</span> skeySpec <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SecretKeySpec</span><span class="token punctuation">(</span>tmp<span class="token punctuation">.</span><span class="token function">getEncoded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;AES&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Cipher</span> cipher <span class="token operator">=</span> <span class="token class-name">Cipher</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token string">&quot;AES/CBC/PKCS5PADDING&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        cipher<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>mode<span class="token punctuation">,</span> skeySpec<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">IvParameterSpec</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> cipher<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> secretKey <span class="token operator">=</span> <span class="token string">&quot;Secret&quot;</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> fSalt <span class="token operator">=</span> <span class="token string">&quot;tJHnN5b1i6wvXMwzYMRk&quot;</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> plainText <span class="token operator">=</span> <span class="token string">&quot;England&quot;</span><span class="token punctuation">;</span>

        <span class="token class-name">String</span> cipherText <span class="token operator">=</span> <span class="token function">encrypt</span><span class="token punctuation">(</span>secretKey<span class="token punctuation">,</span> fSalt<span class="token punctuation">,</span> plainText<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Cipher: &quot;</span> <span class="token operator">+</span> cipherText<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//      cipherText = &quot;6peDTxE1xgLE4hTGg0PKTnuuhFC1Vftsd7NH9DF/7WM=&quot;; // Cipher from python</span>
        <span class="token class-name">String</span> dcrCipherText <span class="token operator">=</span> <span class="token function">decrypt</span><span class="token punctuation">(</span>secretKey<span class="token punctuation">,</span> fSalt<span class="token punctuation">,</span> cipherText<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>dcrCipherText<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
</code></pre></div><p>1.2 Python Code(version 3.6) &amp; Pycrypto V2.6：</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> base64
<span class="token keyword">import</span> hashlib
<span class="token keyword">import</span> os

<span class="token keyword">from</span> Crypto<span class="token punctuation">.</span>Cipher <span class="token keyword">import</span> AES

BS <span class="token operator">=</span> <span class="token number">16</span>
pad <span class="token operator">=</span> <span class="token keyword">lambda</span> s<span class="token punctuation">:</span> s <span class="token operator">+</span> <span class="token punctuation">(</span>BS <span class="token operator">-</span> <span class="token builtin">len</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token operator">%</span> BS<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token builtin">chr</span><span class="token punctuation">(</span>BS <span class="token operator">-</span> <span class="token builtin">len</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token operator">%</span> BS<span class="token punctuation">)</span>

<span class="token comment"># unpad = lambda s: s[:-ord(s[len(s) - 1:])]</span>
unpad <span class="token operator">=</span> <span class="token keyword">lambda</span> s<span class="token punctuation">:</span> s<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token operator">-</span>s<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span>

<span class="token keyword">def</span> <span class="token function">get_private_key</span><span class="token punctuation">(</span>secretKey<span class="token punctuation">,</span> salt<span class="token punctuation">)</span><span class="token punctuation">:</span>
    key <span class="token operator">=</span> hashlib<span class="token punctuation">.</span>pbkdf2_hmac<span class="token punctuation">(</span><span class="token string">'SHA256'</span><span class="token punctuation">,</span> secretKey<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> salt<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">65536</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> key


<span class="token keyword">def</span> <span class="token function">encrypt</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> salt<span class="token punctuation">,</span> secretKey<span class="token punctuation">)</span><span class="token punctuation">:</span>
    private_key <span class="token operator">=</span> get_private_key<span class="token punctuation">(</span>secretKey<span class="token punctuation">,</span> salt<span class="token punctuation">)</span>
    message <span class="token operator">=</span> pad<span class="token punctuation">(</span>message<span class="token punctuation">)</span>
    iv <span class="token operator">=</span> os<span class="token punctuation">.</span>urandom<span class="token punctuation">(</span>BS<span class="token punctuation">)</span>  <span class="token comment"># 128-bit IV</span>
    cipher <span class="token operator">=</span> AES<span class="token punctuation">.</span>new<span class="token punctuation">(</span>private_key<span class="token punctuation">,</span> AES<span class="token punctuation">.</span>MODE_CBC<span class="token punctuation">,</span> iv<span class="token punctuation">,</span> segment_size<span class="token operator">=</span><span class="token number">256</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> base64<span class="token punctuation">.</span>b64encode<span class="token punctuation">(</span>iv <span class="token operator">+</span> cipher<span class="token punctuation">.</span>encrypt<span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">decrypt</span><span class="token punctuation">(</span>enc<span class="token punctuation">,</span> salt<span class="token punctuation">,</span> secretKey<span class="token punctuation">)</span><span class="token punctuation">:</span>
    private_key <span class="token operator">=</span> get_private_key<span class="token punctuation">(</span>secretKey<span class="token punctuation">,</span> salt<span class="token punctuation">)</span>
    enc <span class="token operator">=</span> base64<span class="token punctuation">.</span>b64decode<span class="token punctuation">(</span>enc<span class="token punctuation">)</span>
    iv <span class="token operator">=</span> enc<span class="token punctuation">[</span><span class="token punctuation">:</span>BS<span class="token punctuation">]</span>
    cipher <span class="token operator">=</span> AES<span class="token punctuation">.</span>new<span class="token punctuation">(</span>private_key<span class="token punctuation">,</span> AES<span class="token punctuation">.</span>MODE_CBC<span class="token punctuation">,</span> iv<span class="token punctuation">,</span> segment_size<span class="token operator">=</span><span class="token number">256</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> unpad<span class="token punctuation">(</span>cipher<span class="token punctuation">.</span>decrypt<span class="token punctuation">(</span>enc<span class="token punctuation">[</span>BS<span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>


secretKey <span class="token operator">=</span> <span class="token string">&quot;Secret&quot;</span>
salt <span class="token operator">=</span> <span class="token string">&quot;tJHnN5b1i6wvXMwzYMRk&quot;</span>
plainText <span class="token operator">=</span> <span class="token string">&quot;England&quot;</span>
cipher <span class="token operator">=</span> encrypt<span class="token punctuation">(</span>plainText<span class="token punctuation">,</span> salt<span class="token punctuation">,</span> secretKey<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Cipher: &quot;</span> <span class="token operator">+</span> <span class="token builtin">bytes</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span>cipher<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment"># cipher = &quot;0JrZdg9YBRshfTdr1d4zwQ==&quot; # Cipher from java</span>
decrypted <span class="token operator">=</span> decrypt<span class="token punctuation">(</span>cipher<span class="token punctuation">,</span> salt<span class="token punctuation">,</span> secretKey<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Decrypted &quot;</span> <span class="token operator">+</span> <span class="token builtin">bytes</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span>decrypted<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="_4-share"><a href="#_4-share" class="header-anchor">#</a> 4.Share:</h3> <p>https://vimsky.com/zh-tw/examples/detail/python-attribute-sqlalchemy.dialects.postgresql.ARRAY.html
Python postgresql.ARRAY屬性代碼示例</p> <p>https://zhuanlan.zhihu.com/p/32840472
flask_appbuilder使用过程中遇到的坑之一</p> <p>https://www.jianshu.com/p/8427da16729a
Flask - SQLalchemy 之 lazy 属性</p> <p>https://blog.csdn.net/qq_41118891/article/details/103711742
Python连接Mysql数据库——ModuleNotFoundError：No module named 'mysql'</p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.65b0f24a.js" defer></script><script src="/assets/js/2.d6ca9a42.js" defer></script><script src="/assets/js/103.4e1cd420.js" defer></script>
  </body>
</html>
