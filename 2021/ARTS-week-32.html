<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>ARTS-week-32 | Oceantime&#39;s blog</title>
    <meta name="generator" content="VuePress 1.5.3">
    <link rel="icon" href="/logo.jpg">
    <meta name="description" content="Oceantime 个人网站">
    <link rel="preload" href="/assets/css/0.styles.abfd12c2.css" as="style"><link rel="preload" href="/assets/js/app.65b0f24a.js" as="script"><link rel="preload" href="/assets/js/2.d6ca9a42.js" as="script"><link rel="preload" href="/assets/js/111.bd5d0a8b.js" as="script"><link rel="prefetch" href="/assets/js/10.ad6941e4.js"><link rel="prefetch" href="/assets/js/100.8ade9f63.js"><link rel="prefetch" href="/assets/js/101.a15dfa49.js"><link rel="prefetch" href="/assets/js/102.761bd3ff.js"><link rel="prefetch" href="/assets/js/103.4e1cd420.js"><link rel="prefetch" href="/assets/js/104.6cfd7216.js"><link rel="prefetch" href="/assets/js/105.e2d93a01.js"><link rel="prefetch" href="/assets/js/106.6151bc8f.js"><link rel="prefetch" href="/assets/js/107.ad872ea3.js"><link rel="prefetch" href="/assets/js/108.bc756e31.js"><link rel="prefetch" href="/assets/js/109.fe77c5ed.js"><link rel="prefetch" href="/assets/js/11.f05321e1.js"><link rel="prefetch" href="/assets/js/110.39bd8ea8.js"><link rel="prefetch" href="/assets/js/112.66f93d20.js"><link rel="prefetch" href="/assets/js/113.e3f1b94f.js"><link rel="prefetch" href="/assets/js/114.6ca21a56.js"><link rel="prefetch" href="/assets/js/115.2369b994.js"><link rel="prefetch" href="/assets/js/116.ef676fd0.js"><link rel="prefetch" href="/assets/js/117.7762c22c.js"><link rel="prefetch" href="/assets/js/118.dc732d76.js"><link rel="prefetch" href="/assets/js/119.2b7f1a4d.js"><link rel="prefetch" href="/assets/js/12.b607cc9e.js"><link rel="prefetch" href="/assets/js/120.1b132ede.js"><link rel="prefetch" href="/assets/js/121.ff9a3172.js"><link rel="prefetch" href="/assets/js/122.2f47d49f.js"><link rel="prefetch" href="/assets/js/13.67af4ad6.js"><link rel="prefetch" href="/assets/js/14.c7827c0f.js"><link rel="prefetch" href="/assets/js/15.eedb1566.js"><link rel="prefetch" href="/assets/js/16.fe37cbf7.js"><link rel="prefetch" href="/assets/js/17.a38f0ae2.js"><link rel="prefetch" href="/assets/js/18.4990ee61.js"><link rel="prefetch" href="/assets/js/19.f4dbb6de.js"><link rel="prefetch" href="/assets/js/20.9ffd67c9.js"><link rel="prefetch" href="/assets/js/21.ac6e1d53.js"><link rel="prefetch" href="/assets/js/22.76b0e02e.js"><link rel="prefetch" href="/assets/js/23.ff3410dc.js"><link rel="prefetch" href="/assets/js/24.f76a6fea.js"><link rel="prefetch" href="/assets/js/25.0534f43c.js"><link rel="prefetch" href="/assets/js/26.c3725782.js"><link rel="prefetch" href="/assets/js/27.deb9c9f3.js"><link rel="prefetch" href="/assets/js/28.6f99ddc2.js"><link rel="prefetch" href="/assets/js/29.02cfc711.js"><link rel="prefetch" href="/assets/js/3.9f6270c9.js"><link rel="prefetch" href="/assets/js/30.ccabc2c3.js"><link rel="prefetch" href="/assets/js/31.b08f8990.js"><link rel="prefetch" href="/assets/js/32.ee62ba38.js"><link rel="prefetch" href="/assets/js/33.f7629f38.js"><link rel="prefetch" href="/assets/js/34.2853c933.js"><link rel="prefetch" href="/assets/js/35.97e611fd.js"><link rel="prefetch" href="/assets/js/36.fa3c8ed4.js"><link rel="prefetch" href="/assets/js/37.8ae8d904.js"><link rel="prefetch" href="/assets/js/38.05c35d7b.js"><link rel="prefetch" href="/assets/js/39.e5258c9e.js"><link rel="prefetch" href="/assets/js/4.ecc02e05.js"><link rel="prefetch" href="/assets/js/40.d668fe84.js"><link rel="prefetch" href="/assets/js/41.c09eb1d5.js"><link rel="prefetch" href="/assets/js/42.b940c3f3.js"><link rel="prefetch" href="/assets/js/43.5f4e8385.js"><link rel="prefetch" href="/assets/js/44.7231a1e4.js"><link rel="prefetch" href="/assets/js/45.585825f0.js"><link rel="prefetch" href="/assets/js/46.14ddc0e4.js"><link rel="prefetch" href="/assets/js/47.52d53fb0.js"><link rel="prefetch" href="/assets/js/48.01214996.js"><link rel="prefetch" href="/assets/js/49.a8e7ddc6.js"><link rel="prefetch" href="/assets/js/5.755ee6e4.js"><link rel="prefetch" href="/assets/js/50.8ef31d09.js"><link rel="prefetch" href="/assets/js/51.86c845e5.js"><link rel="prefetch" href="/assets/js/52.0d1a6570.js"><link rel="prefetch" href="/assets/js/53.0b2ca6b6.js"><link rel="prefetch" href="/assets/js/54.daa0b522.js"><link rel="prefetch" href="/assets/js/55.b7e6d8cc.js"><link rel="prefetch" href="/assets/js/56.67e22da8.js"><link rel="prefetch" href="/assets/js/57.1b8d87fd.js"><link rel="prefetch" href="/assets/js/58.4ef89df1.js"><link rel="prefetch" href="/assets/js/59.abdf0f5c.js"><link rel="prefetch" href="/assets/js/6.3df7280b.js"><link rel="prefetch" href="/assets/js/60.35f8805b.js"><link rel="prefetch" href="/assets/js/61.68fa7ebd.js"><link rel="prefetch" href="/assets/js/62.fd6b0085.js"><link rel="prefetch" href="/assets/js/63.af0dbde2.js"><link rel="prefetch" href="/assets/js/64.16a1ffec.js"><link rel="prefetch" href="/assets/js/65.af1a9908.js"><link rel="prefetch" href="/assets/js/66.0ab56108.js"><link rel="prefetch" href="/assets/js/67.7b28f376.js"><link rel="prefetch" href="/assets/js/68.be9ab4b2.js"><link rel="prefetch" href="/assets/js/69.c030abbd.js"><link rel="prefetch" href="/assets/js/7.3549904d.js"><link rel="prefetch" href="/assets/js/70.1469061c.js"><link rel="prefetch" href="/assets/js/71.4802b635.js"><link rel="prefetch" href="/assets/js/72.83cb541b.js"><link rel="prefetch" href="/assets/js/73.3ad064c7.js"><link rel="prefetch" href="/assets/js/74.00cd90be.js"><link rel="prefetch" href="/assets/js/75.cbf47e0f.js"><link rel="prefetch" href="/assets/js/76.44ccee9d.js"><link rel="prefetch" href="/assets/js/77.e9c38d7e.js"><link rel="prefetch" href="/assets/js/78.9122406c.js"><link rel="prefetch" href="/assets/js/79.5478a7f9.js"><link rel="prefetch" href="/assets/js/8.183e1cde.js"><link rel="prefetch" href="/assets/js/80.81f8b615.js"><link rel="prefetch" href="/assets/js/81.ceada5ea.js"><link rel="prefetch" href="/assets/js/82.6106ff2d.js"><link rel="prefetch" href="/assets/js/83.59665864.js"><link rel="prefetch" href="/assets/js/84.14e761a8.js"><link rel="prefetch" href="/assets/js/85.dd1f6fdb.js"><link rel="prefetch" href="/assets/js/86.c780faa6.js"><link rel="prefetch" href="/assets/js/87.b6a78c96.js"><link rel="prefetch" href="/assets/js/88.e6f83878.js"><link rel="prefetch" href="/assets/js/89.3b38af38.js"><link rel="prefetch" href="/assets/js/9.d9ab8dd1.js"><link rel="prefetch" href="/assets/js/90.64e54699.js"><link rel="prefetch" href="/assets/js/91.b0c97860.js"><link rel="prefetch" href="/assets/js/92.a49f1aa9.js"><link rel="prefetch" href="/assets/js/93.30383993.js"><link rel="prefetch" href="/assets/js/94.e5ff08c3.js"><link rel="prefetch" href="/assets/js/95.6ee9cb6c.js"><link rel="prefetch" href="/assets/js/96.829351f9.js"><link rel="prefetch" href="/assets/js/97.dcf9c2e9.js"><link rel="prefetch" href="/assets/js/98.58af886e.js"><link rel="prefetch" href="/assets/js/99.d137b7f6.js">
    <link rel="stylesheet" href="/assets/css/0.styles.abfd12c2.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Oceantime's blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/accumulate/" class="nav-link">
  前端基础
</a></div><div class="nav-item"><a href="/algorithm/" class="nav-link">
  算法题库
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/accumulate/" class="nav-link">
  前端基础
</a></div><div class="nav-item"><a href="/algorithm/" class="nav-link">
  算法题库
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>ARTS-week-32</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/2021/ARTS-week-32.html#arts-2019-左耳听风社群活动-每周完成一个-arts" class="sidebar-link">ARTS-2019 左耳听风社群活动--每周完成一个 ARTS</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/2021/ARTS-week-32.html#_1-algorithm" class="sidebar-link">1.Algorithm:</a></li><li class="sidebar-sub-header"><a href="/2021/ARTS-week-32.html#_2-review" class="sidebar-link">2.Review:</a></li><li class="sidebar-sub-header"><a href="/2021/ARTS-week-32.html#_3-tip" class="sidebar-link">3.Tip:</a></li><li class="sidebar-sub-header"><a href="/2021/ARTS-week-32.html#_4-share" class="sidebar-link">4.Share:</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="arts-2019-左耳听风社群活动-每周完成一个-arts"><a href="#arts-2019-左耳听风社群活动-每周完成一个-arts" class="header-anchor">#</a> ARTS-2019 左耳听风社群活动--每周完成一个 ARTS</h2> <p>1.Algorithm： 每周至少做一个 leetcode 的算法题
2.Review: 阅读并点评至少一篇英文技术文章
3.Tip: 学习至少一个技术技巧
4.Share: 分享一篇有观点和思考的技术文章</p> <h3 id="_1-algorithm"><a href="#_1-algorithm" class="header-anchor">#</a> 1.Algorithm:</h3> <ol start="480"><li>滑动窗口中位数：https://leetcode-cn.com/submissions/detail/207095459/</li></ol> <p>面试题 02.01. 移除重复节点：https://leetcode-cn.com/submissions/detail/207072239/</p> <ol start="540"><li>有序数组中的单一元素：https://leetcode-cn.com/submissions/detail/207068002/</li></ol> <h3 id="_2-review"><a href="#_2-review" class="header-anchor">#</a> 2.Review:</h3> <p>https://www.mihaileric.com/posts/machine-learning-project-model-v1/
从零开始的完整机器学习项目：模型 V1</p> <h4 id="点评："><a href="#点评：" class="header-anchor">#</a> 点评：</h4> <p>在这篇文章中，将继续最后一个帖子离开的地方，并解决整个机器学习产品生命周期的下一阶段：获取初始数据集并执行探索性数据分析。作为快速复习者，请记住，的目标是将数据驱动的解决方案应用于从初始设置到部署的问题。将进行的阶段包括：</p> <ul><li><p>这些将涵盖以下所有内容：</p> <ul><li>构想、组织代码库和设置模组</li> <li>数据集采集和探索性数据分析</li> <li>使用 v1 模型构建和测试管道（此帖子）</li> <li>执行错误分析并向 v2 模型重复</li> <li>部署模型并连接连续集成解决方案</li></ul></li> <li><p>数据预处理：作为构建模型的第一步，需要以正确的格式获取数据，以便将其摄取到训练管道中。回想一下，在上一篇博文中，进行了一些初步的探索性分析以了解数据集的特征。现在想要获取这些数据洞察，并将初始原始数据清理和预处理到 X \右箭头 y十→是 监督学习所需的映射。为此，将定义一些独立的脚本来进行清理和预处理。使用独立脚本，因为这样可以更轻松地分离出最终可以用作管道中可执行阶段的功能。在实践中，这些阶段最终会通过诸如Airflow 之类的工具作为工作流自动化。首先定义一个名为normalize_and_clean_data.py的脚本（完整参考在这里）。</p> <ul><li>这个脚本首先读入的数据：</li></ul> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">read_datapoints</span><span class="token punctuation">(</span>datapath<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> List<span class="token punctuation">[</span>Dict<span class="token punctuation">]</span><span class="token punctuation">:</span>
  <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>datapath<span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
      reader <span class="token operator">=</span> csv<span class="token punctuation">.</span>DictReader<span class="token punctuation">(</span>f<span class="token punctuation">,</span> delimiter<span class="token operator">=</span><span class="token string">&quot;\t&quot;</span><span class="token punctuation">,</span> fieldnames<span class="token operator">=</span><span class="token punctuation">[</span>
          <span class="token string">&quot;id&quot;</span><span class="token punctuation">,</span>
          <span class="token string">&quot;statement_json&quot;</span><span class="token punctuation">,</span>
          <span class="token string">&quot;label&quot;</span><span class="token punctuation">,</span>
          <span class="token string">&quot;statement&quot;</span><span class="token punctuation">,</span>
          <span class="token string">&quot;subject&quot;</span><span class="token punctuation">,</span>
          <span class="token string">&quot;speaker&quot;</span><span class="token punctuation">,</span>
          <span class="token string">&quot;speaker_title&quot;</span><span class="token punctuation">,</span>
          <span class="token string">&quot;state_info&quot;</span><span class="token punctuation">,</span>
          <span class="token string">&quot;party_affiliation&quot;</span><span class="token punctuation">,</span>
          <span class="token string">&quot;barely_true_count&quot;</span><span class="token punctuation">,</span>
          <span class="token string">&quot;false_count&quot;</span><span class="token punctuation">,</span>
          <span class="token string">&quot;half_true_count&quot;</span><span class="token punctuation">,</span>
          <span class="token string">&quot;mostly_true_count&quot;</span><span class="token punctuation">,</span>
          <span class="token string">&quot;pants_fire_count&quot;</span><span class="token punctuation">,</span>
          <span class="token string">&quot;context&quot;</span><span class="token punctuation">,</span>
          <span class="token string">&quot;justification&quot;</span>
      <span class="token punctuation">]</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span> <span class="token punctuation">[</span>row <span class="token keyword">for</span> row <span class="token keyword">in</span> reader<span class="token punctuation">]</span>
</code></pre></div><ul><li>然后进行归一化和清洗：</li></ul> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">normalize_and_clean</span><span class="token punctuation">(</span>datapoints<span class="token punctuation">:</span> List<span class="token punctuation">[</span>Dict<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> List<span class="token punctuation">[</span>Dict<span class="token punctuation">]</span><span class="token punctuation">:</span>
  <span class="token keyword">return</span> normalize_and_clean_speaker_title<span class="token punctuation">(</span>
      normalize_and_clean_party_affiliations<span class="token punctuation">(</span>
          normalize_and_clean_state_info<span class="token punctuation">(</span>
              normalize_and_clean_counts<span class="token punctuation">(</span>
                  normalize_labels<span class="token punctuation">(</span>
                      datapoints
                  <span class="token punctuation">)</span>
              <span class="token punctuation">)</span>
          <span class="token punctuation">)</span>
      <span class="token punctuation">)</span>
  <span class="token punctuation">)</span>
</code></pre></div><ul><li>每个normalize_and_clean函数从原始数据集中清除一个字段。例如，对于Speaker_title字段，有：</li></ul> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">normalize_and_clean_speaker_title</span><span class="token punctuation">(</span>datapoints<span class="token punctuation">:</span> List<span class="token punctuation">[</span>Dict<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> List<span class="token punctuation">[</span>Dict<span class="token punctuation">]</span><span class="token punctuation">:</span>
  normalized_datapoints <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token keyword">for</span> datapoint <span class="token keyword">in</span> datapoints<span class="token punctuation">:</span>
      <span class="token comment"># First do simple cleaning</span>
      normalized_datapoint <span class="token operator">=</span> deepcopy<span class="token punctuation">(</span>datapoint<span class="token punctuation">)</span>
      old_speaker_title <span class="token operator">=</span> normalized_datapoint<span class="token punctuation">[</span><span class="token string">&quot;speaker_title&quot;</span><span class="token punctuation">]</span>
      old_speaker_title <span class="token operator">=</span> old_speaker_title<span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">&quot;-&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot; &quot;</span><span class="token punctuation">)</span>
      <span class="token comment"># Then canonicalize</span>
      <span class="token keyword">if</span> old_speaker_title <span class="token keyword">in</span> CANONICAL_SPEAKER_TITLES<span class="token punctuation">:</span>
          old_speaker_title <span class="token operator">=</span> CANONICAL_SPEAKER_TITLES<span class="token punctuation">[</span>old_speaker_title<span class="token punctuation">]</span>
      normalized_datapoint<span class="token punctuation">[</span><span class="token string">&quot;speaker_title&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> old_speaker_title
      normalized_datapoints<span class="token punctuation">.</span>append<span class="token punctuation">(</span>normalized_datapoint<span class="token punctuation">)</span>
  <span class="token keyword">return</span> normalized_datapoints
</code></pre></div><ul><li>为了产生一致的条目，此函数将字段小写，去除任何空格，然后替换某些字符，如破折号。</li> <li>因为的离线特征提取可能是一项昂贵的操作（它不在这里，但让练习良好的工程实践），将bin-形成分离到自己的脚本compute_credit_bins.py 中，其主要功能是：</li></ul> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">&quot;__main__&quot;</span><span class="token punctuation">:</span>
  args <span class="token operator">=</span> read_args<span class="token punctuation">(</span><span class="token punctuation">)</span>
  train_df <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_json<span class="token punctuation">(</span>args<span class="token punctuation">.</span>train_data_path<span class="token punctuation">,</span> orient<span class="token operator">=</span><span class="token string">&quot;records&quot;</span><span class="token punctuation">)</span>
  optimal_credit_bins <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token keyword">for</span> credit_name <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token string">&quot;barely_true_count&quot;</span><span class="token punctuation">,</span>
                      <span class="token string">&quot;false_count&quot;</span><span class="token punctuation">,</span>
                      <span class="token string">&quot;half_true_count&quot;</span><span class="token punctuation">,</span>
                      <span class="token string">&quot;mostly_true_count&quot;</span><span class="token punctuation">,</span>
                      <span class="token string">&quot;pants_fire_count&quot;</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
      optimal_credit_bins<span class="token punctuation">[</span>credit_name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>np<span class="token punctuation">.</span>histogram_bin_edges<span class="token punctuation">(</span>train_df<span class="token punctuation">[</span>credit_name<span class="token punctuation">]</span><span class="token punctuation">,</span>
                                                                     bins<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>output_path<span class="token punctuation">,</span> <span class="token string">&quot;w&quot;</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
      <span class="token keyword">print</span><span class="token punctuation">(</span>optimal_credit_bins<span class="token punctuation">)</span>
      json<span class="token punctuation">.</span>dump<span class="token punctuation">(</span>optimal_credit_bins<span class="token punctuation">,</span> f<span class="token punctuation">)</span>
</code></pre></div><ul><li>这里值得注意的一个工程设计决策：对于这些清理和处理步骤中的每一个，确保脚本对输入文件进行操作并生成输出文件。这保证了的输入保持不变，并且很容易重现。有了这个，就可以开始接触模型（即“真正的”机器学习）。</li></ul></li> <li><p>定义模型:为了建立一些性能相当好的模型，将选择一个随机森林作为的基线模型。就的目的而言，随机森林相对容易设置，并且通常用作任何新问题的首选模型类。如果调整得当，随机森林可以非常有竞争力，甚至是最先进的。如果可以更快地将其完全集成到下游应用程序中，您当然可以使用更简单的东西（例如手动的、基于规则的系统）。这是所有其他模型都应该继承的基本模型类定义。</p> <ul><li>完整定义在这里:</li></ul> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">Model</span><span class="token punctuation">(</span>ABC<span class="token punctuation">)</span><span class="token punctuation">:</span>
  <span class="token decorator annotation punctuation">@abstractmethod</span>
  <span class="token keyword">def</span> <span class="token function">train</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>
            train_datapoints<span class="token punctuation">:</span> List<span class="token punctuation">[</span>Datapoint<span class="token punctuation">]</span><span class="token punctuation">,</span>
            val_datapoints<span class="token punctuation">:</span> List<span class="token punctuation">[</span>Datapoint<span class="token punctuation">]</span><span class="token punctuation">,</span>
            cache_featurizer<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">bool</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">False</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
      <span class="token triple-quoted-string string">&quot;&quot;&quot;
      Performs training of model. The exact train implementations are model specific.
      :param train_datapoints: List of train datapoints
      :param val_datapoints: List of validation datapoints that can be used
      :param cache_featurizer: Whether or not to cache the model featurizer
      :return:
      &quot;&quot;&quot;</span>
      <span class="token keyword">pass</span>
  
  <span class="token decorator annotation punctuation">@abstractmethod</span>
  <span class="token keyword">def</span> <span class="token function">predict</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> datapoints<span class="token punctuation">:</span> List<span class="token punctuation">[</span>Datapoint<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> np<span class="token punctuation">.</span>array<span class="token punctuation">:</span>
      <span class="token triple-quoted-string string">&quot;&quot;&quot;
      Performs inference of model on collection of datapoints. Returns an
      array of model predictions. This should only be called after the model
      has been trained.
      :param datapoints: List of datapoints to perform inference on
      :return: Array of predictions
      &quot;&quot;&quot;</span>
      <span class="token keyword">pass</span>
  
  <span class="token decorator annotation punctuation">@abstractmethod</span>
  <span class="token keyword">def</span> <span class="token function">compute_metrics</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> eval_datapoints<span class="token punctuation">:</span> List<span class="token punctuation">[</span>Datapoint<span class="token punctuation">]</span><span class="token punctuation">,</span> split<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Dict<span class="token punctuation">:</span>
      <span class="token triple-quoted-string string">&quot;&quot;&quot;
      Compute a set of model-specifc metrics on the provided set of datapoints.
      :param eval_datapoints: Datapoints to compute metrics for
      :param split: Data split on which metrics are being computed
      :return: A dictionary mapping from the name of the metric to its value
      &quot;&quot;&quot;</span>
      <span class="token keyword">pass</span>
  
  <span class="token decorator annotation punctuation">@abstractmethod</span>
  <span class="token keyword">def</span> <span class="token function">get_params</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Dict<span class="token punctuation">:</span>
      <span class="token triple-quoted-string string">&quot;&quot;&quot;
      Return the model-specific parameters such as number of hidden-units in the case
      of a neural network or number of trees for a random forest
      :return: Dictionary containing the model parameters
      &quot;&quot;&quot;</span>
      <span class="token keyword">pass</span>
</code></pre></div><ul><li>鉴于此模型接口结合正在利用Scikit-Learn为的模型提供动力的事实，实际的模型定义还不错：</li></ul> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">RandomForestModel</span><span class="token punctuation">(</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>
  <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> config<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span>Dict<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
      self<span class="token punctuation">.</span>config <span class="token operator">=</span> config
      model_cache_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>config<span class="token punctuation">[</span><span class="token string">&quot;model_output_path&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">&quot;model.pkl&quot;</span><span class="token punctuation">)</span>
      self<span class="token punctuation">.</span>featurizer <span class="token operator">=</span> TreeFeaturizer<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>config<span class="token punctuation">[</span><span class="token string">&quot;featurizer_output_path&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                                                    <span class="token string">&quot;featurizer.pkl&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                       config<span class="token punctuation">)</span>
      <span class="token keyword">if</span> config<span class="token punctuation">[</span><span class="token string">&quot;evaluate&quot;</span><span class="token punctuation">]</span> <span class="token keyword">and</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>model_cache_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
          <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">&quot;Model output path does not exist but in `evaluate` mode!&quot;</span><span class="token punctuation">)</span>
      <span class="token keyword">if</span> model_cache_path <span class="token keyword">and</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>model_cache_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
          LOGGER<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">&quot;Loading model from cache...&quot;</span><span class="token punctuation">)</span>
          <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>model_cache_path<span class="token punctuation">,</span> <span class="token string">&quot;rb&quot;</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
              self<span class="token punctuation">.</span>model <span class="token operator">=</span> pickle<span class="token punctuation">.</span>load<span class="token punctuation">(</span>f<span class="token punctuation">)</span>
      <span class="token keyword">else</span><span class="token punctuation">:</span>
          LOGGER<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">&quot;Initializing model from scratch...&quot;</span><span class="token punctuation">)</span>
          self<span class="token punctuation">.</span>model <span class="token operator">=</span> RandomForestClassifier<span class="token punctuation">(</span><span class="token operator">**</span>self<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">&quot;params&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  
  <span class="token keyword">def</span> <span class="token function">train</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>
            train_datapoints<span class="token punctuation">:</span> List<span class="token punctuation">[</span>Datapoint<span class="token punctuation">]</span><span class="token punctuation">,</span>
            val_datapoints<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span>List<span class="token punctuation">[</span>Datapoint<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            cache_featurizer<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">bool</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">False</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
      self<span class="token punctuation">.</span>featurizer<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>train_datapoints<span class="token punctuation">)</span>
      <span class="token keyword">if</span> cache_featurizer<span class="token punctuation">:</span>
          feature_names <span class="token operator">=</span> self<span class="token punctuation">.</span>featurizer<span class="token punctuation">.</span>get_all_feature_names<span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>self<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">&quot;model_output_path&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                                 <span class="token string">&quot;feature_names.pkl&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;wb&quot;</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
              pickle<span class="token punctuation">.</span>dump<span class="token punctuation">(</span>feature_names<span class="token punctuation">,</span> f<span class="token punctuation">)</span>
          self<span class="token punctuation">.</span>featurizer<span class="token punctuation">.</span>save<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>self<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">&quot;featurizer_output_path&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                                            <span class="token string">&quot;featurizer.pkl&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      train_labels <span class="token operator">=</span> <span class="token punctuation">[</span>datapoint<span class="token punctuation">.</span>label <span class="token keyword">for</span> datapoint <span class="token keyword">in</span> train_datapoints<span class="token punctuation">]</span>
      LOGGER<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">&quot;Featurizing data from scratch...&quot;</span><span class="token punctuation">)</span>
      train_features <span class="token operator">=</span> self<span class="token punctuation">.</span>featurizer<span class="token punctuation">.</span>featurize<span class="token punctuation">(</span>train_datapoints<span class="token punctuation">)</span>
      self<span class="token punctuation">.</span>model<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>train_features<span class="token punctuation">,</span> train_labels<span class="token punctuation">)</span>
  
  <span class="token keyword">def</span> <span class="token function">compute_metrics</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> eval_datapoints<span class="token punctuation">:</span> List<span class="token punctuation">[</span>Datapoint<span class="token punctuation">]</span><span class="token punctuation">,</span> split<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Dict<span class="token punctuation">:</span>
      expected_labels <span class="token operator">=</span> <span class="token punctuation">[</span>datapoint<span class="token punctuation">.</span>label <span class="token keyword">for</span> datapoint <span class="token keyword">in</span> eval_datapoints<span class="token punctuation">]</span>
      predicted_proba <span class="token operator">=</span> self<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>eval_datapoints<span class="token punctuation">)</span>
      predicted_labels <span class="token operator">=</span> np<span class="token punctuation">.</span>argmax<span class="token punctuation">(</span>predicted_proba<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
      accuracy <span class="token operator">=</span> accuracy_score<span class="token punctuation">(</span>expected_labels<span class="token punctuation">,</span> predicted_labels<span class="token punctuation">)</span>
      f1 <span class="token operator">=</span> f1_score<span class="token punctuation">(</span>expected_labels<span class="token punctuation">,</span> predicted_labels<span class="token punctuation">)</span>
      auc <span class="token operator">=</span> roc_auc_score<span class="token punctuation">(</span>expected_labels<span class="token punctuation">,</span> predicted_proba<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
      conf_mat <span class="token operator">=</span> confusion_matrix<span class="token punctuation">(</span>expected_labels<span class="token punctuation">,</span> predicted_labels<span class="token punctuation">)</span>
      tn<span class="token punctuation">,</span> fp<span class="token punctuation">,</span> fn<span class="token punctuation">,</span> tp <span class="token operator">=</span> conf_mat<span class="token punctuation">.</span>ravel<span class="token punctuation">(</span><span class="token punctuation">)</span>
      split_prefix <span class="token operator">=</span> <span class="token string">&quot;&quot;</span> <span class="token keyword">if</span> split <span class="token keyword">is</span> <span class="token boolean">None</span> <span class="token keyword">else</span> split
      <span class="token keyword">return</span> <span class="token punctuation">{</span>
          <span class="token string-interpolation"><span class="token string">f&quot;</span><span class="token interpolation"><span class="token punctuation">{</span>split_prefix<span class="token punctuation">}</span></span><span class="token string"> f1&quot;</span></span><span class="token punctuation">:</span> f1<span class="token punctuation">,</span>
          <span class="token string-interpolation"><span class="token string">f&quot;</span><span class="token interpolation"><span class="token punctuation">{</span>split_prefix<span class="token punctuation">}</span></span><span class="token string"> accuracy&quot;</span></span><span class="token punctuation">:</span> accuracy<span class="token punctuation">,</span>
          <span class="token string-interpolation"><span class="token string">f&quot;</span><span class="token interpolation"><span class="token punctuation">{</span>split_prefix<span class="token punctuation">}</span></span><span class="token string"> auc&quot;</span></span><span class="token punctuation">:</span> auc<span class="token punctuation">,</span>
          <span class="token string-interpolation"><span class="token string">f&quot;</span><span class="token interpolation"><span class="token punctuation">{</span>split_prefix<span class="token punctuation">}</span></span><span class="token string"> true negative&quot;</span></span><span class="token punctuation">:</span> tn<span class="token punctuation">,</span>
          <span class="token string-interpolation"><span class="token string">f&quot;</span><span class="token interpolation"><span class="token punctuation">{</span>split_prefix<span class="token punctuation">}</span></span><span class="token string"> false negative&quot;</span></span><span class="token punctuation">:</span> fn<span class="token punctuation">,</span>
          <span class="token string-interpolation"><span class="token string">f&quot;</span><span class="token interpolation"><span class="token punctuation">{</span>split_prefix<span class="token punctuation">}</span></span><span class="token string"> false positive&quot;</span></span><span class="token punctuation">:</span> fp<span class="token punctuation">,</span>
          <span class="token string-interpolation"><span class="token string">f&quot;</span><span class="token interpolation"><span class="token punctuation">{</span>split_prefix<span class="token punctuation">}</span></span><span class="token string"> true positive&quot;</span></span><span class="token punctuation">:</span> tp<span class="token punctuation">,</span>
      <span class="token punctuation">}</span>
  
  <span class="token keyword">def</span> <span class="token function">predict</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> datapoints<span class="token punctuation">:</span> List<span class="token punctuation">[</span>Datapoint<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> np<span class="token punctuation">.</span>array<span class="token punctuation">:</span>
      features <span class="token operator">=</span> self<span class="token punctuation">.</span>featurizer<span class="token punctuation">.</span>featurize<span class="token punctuation">(</span>datapoints<span class="token punctuation">)</span>
      <span class="token keyword">return</span> self<span class="token punctuation">.</span>model<span class="token punctuation">.</span>predict_proba<span class="token punctuation">(</span>features<span class="token punctuation">)</span>
  
  <span class="token keyword">def</span> <span class="token function">get_params</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Dict<span class="token punctuation">:</span>
      <span class="token keyword">return</span> self<span class="token punctuation">.</span>model<span class="token punctuation">.</span>get_params<span class="token punctuation">(</span><span class="token punctuation">)</span>
  
  <span class="token keyword">def</span> <span class="token function">save</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> model_cache_path<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
      LOGGER<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">&quot;Saving model to disk...&quot;</span><span class="token punctuation">)</span>
      <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>model_cache_path<span class="token punctuation">,</span> <span class="token string">&quot;wb&quot;</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
          pickle<span class="token punctuation">.</span>dump<span class="token punctuation">(</span>self<span class="token punctuation">.</span>model<span class="token punctuation">,</span> f<span class="token punctuation">)</span>
</code></pre></div><ul><li>虽然这看起来很复杂，但如果仔细观察，实际模型训练的大部分只是几行。剩下的就是调用的 featurizer（细节如下）并执行设置/缓存。</li></ul></li> <li><p>特征</p> <ul><li>如果没有一组好的预测特征，机器学习模型本身就毫无用处。在的例子中，想给的随机森林正确的信号来学习足够的假新闻鉴别器。</li> <li>将为初始模型使用两种类型的特征：1）manual 特征和 2）ngram 特征。Ngram 特征在处理文本时通常很有用，因为它允许获取数据中的某些词汇和语言模式。将对这些特征使用 tfidf 权重，而不是原始 ngram，因为这些类型的权重经常用于信息检索，以帮助提高/降低某些单词的重要性。许多使用 ngram 功能完成的工作由库（如 Scikit-learn）为处理。将使用自己的manual 功能来扩充这个初始功能集。这类功能是真正可以编写特定数据洞察的地方。作为一个例子，选择以提取和独热编码各种领域，诸如 speaker，speaker_title，state_info，和party_affiliation。此外，在探索性数据分析中看到的一个特别有趣的领域是“信用记录”。将这些计数归入 10 个区间之一，每个区间的边以特定于字段的方式定义。</li> <li>这一切看起来像这样：</li></ul> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">extract_manual_features</span><span class="token punctuation">(</span>datapoints<span class="token punctuation">:</span> List<span class="token punctuation">[</span>Datapoint<span class="token punctuation">]</span><span class="token punctuation">,</span> optimal_credit_bins<span class="token punctuation">:</span> Dict<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> List<span class="token punctuation">[</span>Dict<span class="token punctuation">]</span><span class="token punctuation">:</span>
  all_features <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token keyword">for</span> datapoint <span class="token keyword">in</span> datapoints<span class="token punctuation">:</span>
      features <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
      features<span class="token punctuation">[</span><span class="token string">&quot;speaker&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> datapoint<span class="token punctuation">.</span>speaker
      features<span class="token punctuation">[</span><span class="token string">&quot;speaker_title&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> datapoint<span class="token punctuation">.</span>speaker_title
      features<span class="token punctuation">[</span><span class="token string">&quot;state_info&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> datapoint<span class="token punctuation">.</span>state_info
      features<span class="token punctuation">[</span><span class="token string">&quot;party_affiliation&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> datapoint<span class="token punctuation">.</span>party_affiliation
      <span class="token comment"># Compute credit score features</span>
      datapoint <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>datapoint<span class="token punctuation">)</span>
      <span class="token keyword">for</span> feat <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token string">&quot;barely_true_count&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;false_count&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;half_true_count&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;mostly_true_count&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;pants_fire_count&quot;</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
          features<span class="token punctuation">[</span>feat<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>compute_bin_idx<span class="token punctuation">(</span>datapoint<span class="token punctuation">[</span>feat<span class="token punctuation">]</span><span class="token punctuation">,</span> optimal_credit_bins<span class="token punctuation">[</span>feat<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      all_features<span class="token punctuation">.</span>append<span class="token punctuation">(</span>features<span class="token punctuation">)</span>
  <span class="token keyword">return</span> all_features
</code></pre></div><ul><li>特征化代码的核心看起来像这样（使用一堆 Scikit-learn 原语定义）：</li></ul> <div class="language-python extra-class"><pre class="language-python"><code>dict_featurizer <span class="token operator">=</span> DictVectorizer<span class="token punctuation">(</span><span class="token punctuation">)</span>
tfidf_featurizer <span class="token operator">=</span> TfidfVectorizer<span class="token punctuation">(</span><span class="token punctuation">)</span>

statement_transformer <span class="token operator">=</span> FunctionTransformer<span class="token punctuation">(</span>extract_statements<span class="token punctuation">)</span>
manual_feature_transformer <span class="token operator">=</span> FunctionTransformer<span class="token punctuation">(</span>partial<span class="token punctuation">(</span>extract_manual_features<span class="token punctuation">,</span>
                                                            optimal_credit_bins<span class="token operator">=</span>optimal_credit_bins<span class="token punctuation">)</span><span class="token punctuation">)</span>

manual_feature_pipeline <span class="token operator">=</span> Pipeline<span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token punctuation">(</span><span class="token string">&quot;manual_features&quot;</span><span class="token punctuation">,</span> manual_feature_transformer<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token string">&quot;manual_featurizer&quot;</span><span class="token punctuation">,</span> dict_featurizer<span class="token punctuation">)</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>

ngram_feature_pipeline <span class="token operator">=</span> Pipeline<span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token punctuation">(</span><span class="token string">&quot;statements&quot;</span><span class="token punctuation">,</span> statement_transformer<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token string">&quot;ngram_featurizer&quot;</span><span class="token punctuation">,</span> tfidf_featurizer<span class="token punctuation">)</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>

self<span class="token punctuation">.</span>combined_featurizer <span class="token operator">=</span> FeatureUnion<span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token punctuation">(</span><span class="token string">&quot;manual_feature_pipe&quot;</span><span class="token punctuation">,</span> manual_feature_pipeline<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token string">&quot;ngram_feature_pipe&quot;</span><span class="token punctuation">,</span> ngram_feature_pipeline<span class="token punctuation">)</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre></div><ul><li>上面要注意的一件事是，一旦提取了单独的 ngram 和手动特征向量，将它们连接成一个向量（通过特征联合）。这个聚合向量现在存储了想要从数据中捕获并提供给模型的所有最显着的信息。关于工程的最后评论：将定义一个单独的Featurizer类，它将公开一个用于训练特征化器（对于基于 ngram 的权重是必需的）和特征化任意数据的接口：</li></ul> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">TreeFeaturizer</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
  <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">)</span><span class="token punctuation">:</span>
      <span class="token keyword">pass</span>
  
  <span class="token keyword">def</span> <span class="token function">fit</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> datapoints<span class="token punctuation">:</span> List<span class="token punctuation">[</span>Datapoint<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
      <span class="token keyword">raise</span> NotImplementedError
  
  <span class="token keyword">def</span> <span class="token function">featurize</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> datapoints<span class="token punctuation">:</span> List<span class="token punctuation">[</span>Datapoint<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> np<span class="token punctuation">.</span>array<span class="token punctuation">:</span>
      <span class="token keyword">raise</span> NotImplementedError
</code></pre></div></li> <li><p>训练流水线：好的，现在有了很棒的功能和很酷的模型。让将它们编织成一个功能训练/评估管道。任何好的训练管道中的一个重要步骤是使其易于配置，即使其易于即插即用管道的不同组件/属性，例如模型、特征化或数据参数。您通常通过传入命令行级参数或提供配置文件来使这些管道可配置。我个人更喜欢配置路径，因为它允许在代码存储库中对实际配置文件进行版本控制和跟踪。将使用JSON格式的文件配置管道。当然，您可以使用其他格式，如YAML等，但我个人对 JSON 有偏见，因为我发现它更易于阅读。</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;model&quot;</span><span class="token operator">:</span> <span class="token string">&quot;random_forest&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;train_data_path&quot;</span><span class="token operator">:</span> <span class="token string">&quot;data/processed/cleaned_train_data.json&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;val_data_path&quot;</span><span class="token operator">:</span> <span class="token string">&quot;data/processed/cleaned_val_data.json&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;test_data_path&quot;</span><span class="token operator">:</span> <span class="token string">&quot;data/processed/cleaned_test_data.json&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;featurizer_output_path&quot;</span><span class="token operator">:</span> <span class="token string">&quot;model_checkpoints/random_forest&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;credit_bins_path&quot;</span><span class="token operator">:</span> <span class="token string">&quot;data/processed/optimal_credit_bins.json&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;model_output_path&quot;</span><span class="token operator">:</span> <span class="token string">&quot;model_checkpoints/random_forest&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;evaluate&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token property">&quot;params&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>定义相对简单。定义模型类型，应该从哪里提取数据，应该将模型和特征器写入哪里，是处于评估模式还是训练模式，以及任何特定于模型的参数。在此处将参数保留为空，因为使用的是 Scikit-learn 随机森林默认值，但您可以使用此字段指定您想要使用的任何内容（即树的数量、分割标准等）接下来将转到训练管道，它将负责将所有内容拼接成一系列可执行的步骤。在前几节中完成了大部分繁重的工作，因此管道主要是样板：</li></ul> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">&quot;__main__&quot;</span><span class="token punctuation">:</span>
  args <span class="token operator">=</span> read_args<span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>config_file<span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
      config <span class="token operator">=</span> json<span class="token punctuation">.</span>load<span class="token punctuation">(</span>f<span class="token punctuation">)</span>
  
  set_random_seed<span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span>
  mlflow<span class="token punctuation">.</span>set_experiment<span class="token punctuation">(</span>config<span class="token punctuation">[</span><span class="token string">&quot;model&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  
  base_dir <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>dirname<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>dirname<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>abspath<span class="token punctuation">(</span>__file__<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  model_output_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>base_dir<span class="token punctuation">,</span> config<span class="token punctuation">[</span><span class="token string">&quot;model_output_path&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token comment"># Update full model output path</span>
  config<span class="token punctuation">[</span><span class="token string">&quot;model_output_path&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> model_output_path
  os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span>model_output_path<span class="token punctuation">,</span> exist_ok<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
  <span class="token comment"># Copy config to model directory</span>
  copy<span class="token punctuation">(</span>args<span class="token punctuation">.</span>config_file<span class="token punctuation">,</span> model_output_path<span class="token punctuation">)</span>
  <span class="token keyword">with</span> mlflow<span class="token punctuation">.</span>start_run<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> run<span class="token punctuation">:</span>
      <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>model_output_path<span class="token punctuation">,</span> <span class="token string">&quot;meta.json&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;w&quot;</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
          json<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">&quot;mlflow_run_id&quot;</span><span class="token punctuation">:</span> run<span class="token punctuation">.</span>info<span class="token punctuation">.</span>run_id<span class="token punctuation">}</span><span class="token punctuation">,</span> f<span class="token punctuation">)</span>
      mlflow<span class="token punctuation">.</span>set_tags<span class="token punctuation">(</span><span class="token punctuation">{</span>
          <span class="token string">&quot;evaluate&quot;</span><span class="token punctuation">:</span> config<span class="token punctuation">[</span><span class="token string">&quot;evaluate&quot;</span><span class="token punctuation">]</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      
      train_data_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>base_dir<span class="token punctuation">,</span> config<span class="token punctuation">[</span><span class="token string">&quot;train_data_path&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
      val_data_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>base_dir<span class="token punctuation">,</span> config<span class="token punctuation">[</span><span class="token string">&quot;val_data_path&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
      test_data_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>base_dir<span class="token punctuation">,</span> config<span class="token punctuation">[</span><span class="token string">&quot;test_data_path&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
      <span class="token comment"># Read data</span>
      train_datapoints <span class="token operator">=</span> read_json_data<span class="token punctuation">(</span>train_data_path<span class="token punctuation">)</span>
      val_datapoints <span class="token operator">=</span> read_json_data<span class="token punctuation">(</span>val_data_path<span class="token punctuation">)</span>
      test_datapoints <span class="token operator">=</span> read_json_data<span class="token punctuation">(</span>test_data_path<span class="token punctuation">)</span>
      
      <span class="token keyword">if</span> config<span class="token punctuation">[</span><span class="token string">&quot;model&quot;</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">&quot;random_forest&quot;</span><span class="token punctuation">:</span>
          config<span class="token punctuation">[</span><span class="token string">&quot;featurizer_output_path&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>base_dir<span class="token punctuation">,</span> config<span class="token punctuation">[</span><span class="token string">&quot;featurizer_output_path&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
          model <span class="token operator">=</span> RandomForestModel<span class="token punctuation">(</span>config<span class="token punctuation">)</span>
      <span class="token keyword">else</span><span class="token punctuation">:</span>
          <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;Invalid model type </span><span class="token interpolation"><span class="token punctuation">{</span>config<span class="token punctuation">[</span><span class="token string">'model'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string"> provided&quot;</span></span><span class="token punctuation">)</span>
      
      <span class="token keyword">if</span> <span class="token keyword">not</span> config<span class="token punctuation">[</span><span class="token string">&quot;evaluate&quot;</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
          LOGGER<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">&quot;Training model...&quot;</span><span class="token punctuation">)</span>
          model<span class="token punctuation">.</span>train<span class="token punctuation">(</span>train_datapoints<span class="token punctuation">,</span> val_datapoints<span class="token punctuation">,</span> cache_featurizer<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
          <span class="token keyword">if</span> config<span class="token punctuation">[</span><span class="token string">&quot;model&quot;</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">&quot;random_forest&quot;</span><span class="token punctuation">:</span>
              <span class="token comment"># Cache model weights on disk</span>
              model<span class="token punctuation">.</span>save<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>model_output_path<span class="token punctuation">,</span> <span class="token string">&quot;model.pkl&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      
      mlflow<span class="token punctuation">.</span>log_params<span class="token punctuation">(</span>model<span class="token punctuation">.</span>get_params<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      LOGGER<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">&quot;Evaluating model...&quot;</span><span class="token punctuation">)</span>
      metrics <span class="token operator">=</span> model<span class="token punctuation">.</span>compute_metrics<span class="token punctuation">(</span>val_datapoints<span class="token punctuation">,</span> split<span class="token operator">=</span><span class="token string">&quot;val&quot;</span><span class="token punctuation">)</span>
      LOGGER<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;Val metrics: </span><span class="token interpolation"><span class="token punctuation">{</span>metrics<span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span>
      mlflow<span class="token punctuation">.</span>log_metrics<span class="token punctuation">(</span>metrics<span class="token punctuation">)</span>
</code></pre></div></li> <li><p>功能测试</p> <ul><li>当然可以运行完整的管道（会！）但是每次对特征化代码进行小的更改时，真的必须从头开始重新训练模型吗？这很快变得不切实际，特别是如果正在与一个共享代码库的团队合作（即，如果我对特征进行了小的更改，每个人都需要在本地重新训练模型吗？）。为了解决这个问题，需要包括功能测试。这是更广泛的软件工程中非常常见的做法，但遗憾的是，我在机器学习社区中很少看到这种做法。出于目的，将编写一些不同的功能测试。</li> <li>首先，将测试特征化代码。这是超级重要的。不正确的特征化意味着混淆的模型意味着混淆的人类。将测试每个归一化函数：</li></ul> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">test_compute_bin_idx</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
  bins <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">]</span>
  <span class="token keyword">assert</span> compute_bin_idx<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> bins<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span>
  <span class="token keyword">assert</span> compute_bin_idx<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> bins<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span>
  <span class="token keyword">assert</span> compute_bin_idx<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> bins<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span>
  <span class="token keyword">assert</span> compute_bin_idx<span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">,</span> bins<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">3</span>


<span class="token keyword">def</span> <span class="token function">test_normalize_labels</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    datapoints <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span><span class="token string">&quot;label&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;pants-fire&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;ignored_field&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;blah&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token string">&quot;label&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;barely-true&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token string">&quot;label&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;false&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token string">&quot;label&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;true&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token string">&quot;label&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;half-true&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token string">&quot;label&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;mostly-true&quot;</span><span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
    
    expected_converted_datapoints <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span><span class="token string">&quot;label&quot;</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token string">&quot;ignored_field&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;blah&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token string">&quot;label&quot;</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token string">&quot;label&quot;</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token string">&quot;label&quot;</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token string">&quot;label&quot;</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token string">&quot;label&quot;</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
    
    <span class="token keyword">assert</span> normalize_labels<span class="token punctuation">(</span>datapoints<span class="token punctuation">)</span> <span class="token operator">==</span> expected_converted_datapoints
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre></div><ul><li>还将测试的建模代码。在这里，将检查函数的输出是否具有适当的形状，它们是否在正确的范围内（即\leq 1≤1 如果概率），并且可以过度拟合一个小训练集：</li></ul> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">test_rf_overfits_small_dataset</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> sample_datapoints<span class="token punctuation">)</span><span class="token punctuation">:</span>
  model <span class="token operator">=</span> RandomForestModel<span class="token punctuation">(</span>config<span class="token operator">=</span>config<span class="token punctuation">)</span>
  train_labels <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token boolean">True</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">]</span>
  
  model<span class="token punctuation">.</span>train<span class="token punctuation">(</span>sample_datapoints<span class="token punctuation">)</span>
  predicted_labels <span class="token operator">=</span> np<span class="token punctuation">.</span>argmax<span class="token punctuation">(</span>model<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>sample_datapoints<span class="token punctuation">)</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
  predicted_labels <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">map</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> <span class="token builtin">bool</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span> predicted_labels<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword">assert</span> predicted_labels <span class="token operator">==</span> train_labels


<span class="token keyword">def</span> <span class="token function">test_rf_correct_predict_shape</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> sample_datapoints<span class="token punctuation">)</span><span class="token punctuation">:</span>
    model <span class="token operator">=</span> RandomForestModel<span class="token punctuation">(</span>config<span class="token operator">=</span>config<span class="token punctuation">)</span>
    
    model<span class="token punctuation">.</span>train<span class="token punctuation">(</span>sample_datapoints<span class="token punctuation">)</span>
    predicted_labels <span class="token operator">=</span> np<span class="token punctuation">.</span>argmax<span class="token punctuation">(</span>model<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>sample_datapoints<span class="token punctuation">)</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
    
    <span class="token keyword">assert</span> predicted_labels<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">3</span>


<span class="token keyword">def</span> <span class="token function">test_rf_correct_predict_range</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> sample_datapoints<span class="token punctuation">)</span><span class="token punctuation">:</span>
    model <span class="token operator">=</span> RandomForestModel<span class="token punctuation">(</span>config<span class="token operator">=</span>config<span class="token punctuation">)</span>
    
    model<span class="token punctuation">.</span>train<span class="token punctuation">(</span>sample_datapoints<span class="token punctuation">)</span>
    predicted_probs <span class="token operator">=</span> model<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>sample_datapoints<span class="token punctuation">)</span>
    
    <span class="token keyword">assert</span> <span class="token punctuation">(</span>predicted_probs <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  
</code></pre></div><ul><li>将采用的另一种非常重要的测试是数据完整性测试。在这里的意思是检查您的数据源是否具有预期的格式、类型、值范围等的测试。如果数据没有您期望的格式，则管道的其余部分将被搞砸，因为数据是训练管道的开始。当您有一个持续运行的ETL管道定期摄取、处理和转储新数据时，数据测试变得尤为重要。虽然在这里处理的是静态研究数据集，但无论如何都会进行编写数据完整性测试的练习。为此，将使用库Great Expectations。它允许您以简洁的 JSON 片段指定您对数据的期望。出于目的，将检查数据中的一些内容：
<ul><li>所有的数据拆分都有预期的字段（列）</li> <li>定义了语句字段（长度至少为 1）</li> <li>每个“信用历史”列都是≥0</li> <li>标签是布尔值</li> <li>在期望的语法中，看起来像这样：</li></ul> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;data_asset_type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Dataset&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;expectation_suite_name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;fake_news_data_suite&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;expectations&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;expectation_type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;expect_table_columns_to_match_set&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;kwargs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;column_set&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
          <span class="token string">&quot;id&quot;</span><span class="token punctuation">,</span>
          <span class="token string">&quot;statement_json&quot;</span><span class="token punctuation">,</span>
          <span class="token string">&quot;label&quot;</span><span class="token punctuation">,</span>
          <span class="token string">&quot;statement&quot;</span><span class="token punctuation">,</span>
          <span class="token string">&quot;subject&quot;</span><span class="token punctuation">,</span>
          <span class="token string">&quot;speaker&quot;</span><span class="token punctuation">,</span>
          <span class="token string">&quot;speaker_title&quot;</span><span class="token punctuation">,</span>
          <span class="token string">&quot;state_info&quot;</span><span class="token punctuation">,</span>
          <span class="token string">&quot;party_affiliation&quot;</span><span class="token punctuation">,</span>
          <span class="token string">&quot;barely_true_count&quot;</span><span class="token punctuation">,</span>
          <span class="token string">&quot;false_count&quot;</span><span class="token punctuation">,</span>
          <span class="token string">&quot;half_true_count&quot;</span><span class="token punctuation">,</span>
          <span class="token string">&quot;mostly_true_count&quot;</span><span class="token punctuation">,</span>
          <span class="token string">&quot;pants_fire_count&quot;</span><span class="token punctuation">,</span>
          <span class="token string">&quot;context&quot;</span><span class="token punctuation">,</span>
          <span class="token string">&quot;justification&quot;</span>
        <span class="token punctuation">]</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;meta&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;expectation_type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;expect_column_values_to_be_in_set&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;kwargs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;column&quot;</span><span class="token operator">:</span> <span class="token string">&quot;label&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;value_set&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
          <span class="token boolean">true</span><span class="token punctuation">,</span>
          <span class="token boolean">false</span>
        <span class="token punctuation">]</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;meta&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
...
</code></pre></div><ul><li>鉴于此数据套件，将使用Python 脚本以编程方式执行它：</li></ul> <div class="language-python extra-class"><pre class="language-python"><code>context <span class="token operator">=</span> ge<span class="token punctuation">.</span>data_context<span class="token punctuation">.</span>DataContext<span class="token punctuation">(</span><span class="token punctuation">)</span>

datasource_name <span class="token operator">=</span> <span class="token string">&quot;fake_news_data&quot;</span>

train_batch <span class="token operator">=</span> context<span class="token punctuation">.</span>get_batch<span class="token punctuation">(</span>
    <span class="token punctuation">{</span><span class="token string">&quot;path&quot;</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f&quot;</span><span class="token interpolation"><span class="token punctuation">{</span>os<span class="token punctuation">.</span>environ<span class="token punctuation">[</span><span class="token string">'GE_DIR'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">/data/processed/cleaned_train_data.json&quot;</span></span><span class="token punctuation">,</span>
     <span class="token string">&quot;datasource&quot;</span><span class="token punctuation">:</span> datasource_name<span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">&quot;fake_news_data_suite&quot;</span><span class="token punctuation">)</span>
val_batch <span class="token operator">=</span> context<span class="token punctuation">.</span>get_batch<span class="token punctuation">(</span>
    <span class="token punctuation">{</span><span class="token string">&quot;path&quot;</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f&quot;</span><span class="token interpolation"><span class="token punctuation">{</span>os<span class="token punctuation">.</span>environ<span class="token punctuation">[</span><span class="token string">'GE_DIR'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">/data/processed/cleaned_val_data.json&quot;</span></span><span class="token punctuation">,</span>
     <span class="token string">&quot;datasource&quot;</span><span class="token punctuation">:</span> datasource_name<span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">&quot;fake_news_data_suite&quot;</span><span class="token punctuation">)</span>
test_batch <span class="token operator">=</span> context<span class="token punctuation">.</span>get_batch<span class="token punctuation">(</span>
    <span class="token punctuation">{</span><span class="token string">&quot;path&quot;</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f&quot;</span><span class="token interpolation"><span class="token punctuation">{</span>os<span class="token punctuation">.</span>environ<span class="token punctuation">[</span><span class="token string">'GE_DIR'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">/data/processed/cleaned_test_data.json&quot;</span></span><span class="token punctuation">,</span>
     <span class="token string">&quot;datasource&quot;</span><span class="token punctuation">:</span> datasource_name<span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">&quot;fake_news_data_suite&quot;</span><span class="token punctuation">)</span>

results <span class="token operator">=</span> context<span class="token punctuation">.</span>run_validation_operator<span class="token punctuation">(</span>
    <span class="token string">&quot;action_list_operator&quot;</span><span class="token punctuation">,</span>
    assets_to_validate<span class="token operator">=</span><span class="token punctuation">[</span>train_batch<span class="token punctuation">,</span> val_batch<span class="token punctuation">,</span> test_batch<span class="token punctuation">]</span><span class="token punctuation">,</span>
    run_id<span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">(</span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span>results<span class="token punctuation">)</span>
<span class="token keyword">if</span> results<span class="token punctuation">[</span><span class="token string">&quot;success&quot;</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Test suite passed!&quot;</span><span class="token punctuation">)</span>
    exit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Test suite failed!&quot;</span><span class="token punctuation">)</span>
    exit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
</code></pre></div></li> <li>请注意，Great Expectations 还支持直接从命令行运行您的数据套件，但使用的是可以手动调用的 Python 脚本，以便在构建持续集成系统时（在本系列的后续文章中）更轻松一些。</li></ul></li> <li><p>把它放在一起</p> <ul><li>有了所有这些管道，终于可以训练系统：</li></ul> <div class="language-shell extra-class"><pre class="language-shell"><code>python train.py --config-file config/random_forest.json
</code></pre></div><ul><li>输出看起来像这样：</li></ul> <div class="language-shell extra-class"><pre class="language-shell"><code>INFO - <span class="token number">2021</span>-01-21 <span class="token number">21</span>:26:49,779 - features.py - Creating featurizer from scratch<span class="token punctuation">..</span>.
INFO - <span class="token number">2021</span>-01-21 <span class="token number">21</span>:26:49,781 - tree_based.py - Initializing model from scratch<span class="token punctuation">..</span>.
INFO - <span class="token number">2021</span>-01-21 <span class="token number">21</span>:26:49,781 - train.py - Training model<span class="token punctuation">..</span>.
INFO - <span class="token number">2021</span>-01-21 <span class="token number">21</span>:26:50,163 - features.py - Saving featurizer to disk<span class="token punctuation">..</span>.
INFO - <span class="token number">2021</span>-01-21 <span class="token number">21</span>:26:50,169 - tree_based.py - Featurizing data from scratch<span class="token punctuation">..</span>.
INFO - <span class="token number">2021</span>-01-21 <span class="token number">21</span>:26:59,360 - tree_based.py - Saving model to disk<span class="token punctuation">..</span>.
INFO - <span class="token number">2021</span>-01-21 <span class="token number">21</span>:26:59,459 - train.py - Evaluating model<span class="token punctuation">..</span>.
INFO - <span class="token number">2021</span>-01-21 <span class="token number">21</span>:26:59,584 - train.py - Val metrics: <span class="token punctuation">{</span><span class="token string">'val f1'</span><span class="token builtin class-name">:</span> <span class="token number">0.7587628865979381</span>, <span class="token string">'val accuracy'</span><span class="token builtin class-name">:</span> <span class="token number">0.7266355140186916</span>, <span class="token string">'val auc'</span><span class="token builtin class-name">:</span> <span class="token number">0.8156070164865074</span>, <span class="token string">'val true negative'</span><span class="token builtin class-name">:</span> <span class="token number">381</span>, <span class="token string">'val false negative'</span><span class="token builtin class-name">:</span> <span class="token number">116</span>, <span class="token string">'val false positive'</span><span class="token builtin class-name">:</span> <span class="token number">235</span>, <span class="token string">'val true positive'</span><span class="token builtin class-name">:</span> <span class="token number">552</span><span class="token punctuation">}</span>
</code></pre></div><ul><li>如果在测试集上运行：</li></ul> <div class="language-shell extra-class"><pre class="language-shell"><code>INFO - <span class="token number">2021</span>-01-21 <span class="token number">21</span>:28:46,661 - train.py - Test metrics: <span class="token punctuation">{</span><span class="token string">'test f1'</span><span class="token builtin class-name">:</span> <span class="token number">0.7828348504551366</span>, <span class="token string">'test accuracy'</span><span class="token builtin class-name">:</span> <span class="token number">0.7396726422447389</span>, <span class="token string">'test auc'</span><span class="token builtin class-name">:</span> <span class="token number">0.8053471940466883</span>, <span class="token string">'test true negative'</span><span class="token builtin class-name">:</span> <span class="token number">347</span>, <span class="token string">'test false negative'</span><span class="token builtin class-name">:</span> <span class="token number">125</span>, <span class="token string">'test false positive'</span><span class="token builtin class-name">:</span> <span class="token number">209</span>, <span class="token string">'test true positive'</span><span class="token builtin class-name">:</span> <span class="token number">602</span><span class="token punctuation">}</span>
</code></pre></div><ul><li>根据原始论文表 2 中的结果，优于他们分析的所有模型。不错！有了这个，就完成了这篇超长的帖子。已经走了很长一段路，从探索性数据分析后的少量数据洞察，到在数据集上训练非常有竞争力的模型的成熟管道。退后一步，请记住，目标不是尽可能构建最好的模型。目标是获得一些相当不错的模型，可以将其展示给用户以提供价值并启动数据飞轮。当然可以通过执行超参数调整、使用更多功能等来提高该模型的性能。但这留给读者作为练习。</li></ul></li></ul> <h3 id="_3-tip"><a href="#_3-tip" class="header-anchor">#</a> 3.Tip:</h3> <h4 id="dbeaver-连接数据库驱动配置问题"><a href="#dbeaver-连接数据库驱动配置问题" class="header-anchor">#</a> Dbeaver 连接数据库驱动配置问题</h4> <div class="language-shell extra-class"><pre class="language-shell"><code>窗口—<span class="token operator">&gt;</span>首选项—<span class="token operator">&gt;</span>DBeaver—<span class="token operator">&gt;</span>驱动—<span class="token operator">&gt;</span>maven
选择添加镜像，这里采用阿里镜像：
http://maven.aliyun.com/nexus/content/groups/public/
然后向上移动到第一行
</code></pre></div><h4 id="sublime-列对齐功能"><a href="#sublime-列对齐功能" class="header-anchor">#</a> Sublime 列对齐功能</h4> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token number">1</span>. Ctrl + A （全选）
<span class="token number">2</span>. Ctrl + Shift + L （进入列模式）
<span class="token number">3</span>. 按方向键（右键），使光标置于每一行末尾，解除全选状态
<span class="token number">4</span>. 再按 Ctrl + 方向键（左键），使光标置于第二列数据的开头
<span class="token number">5</span>. 最后 Ctrl + K（Alignment插件的改键，原来的ctrl+alt+a，这个组合键可以说和很多软件都有热键冲突，果断更改），使第二行数据对齐！
</code></pre></div><h4 id="golang-文件流-md5-生成方式"><a href="#golang-文件流-md5-生成方式" class="header-anchor">#</a> golang 文件流 MD5 生成方式</h4> <div class="language-golang extra-class"><pre class="language-text"><code>func md5V(str string) string  {
    h := md5.New()
    io.Copy(h, fr)
    return base64.StdEncoding.EncodeToString(h.Sum([]byte(nil)))
}
</code></pre></div><h3 id="_4-share"><a href="#_4-share" class="header-anchor">#</a> 4.Share:</h3> <p>https://zhuanlan.zhihu.com/p/163558476
windows10 部署 docker+k8s 集群</p> <p>https://dabao.me/k8s/k8s-is-starting.html
解决Windows下Docker Desktop 总是 kubernetes is starting...</p> <p>https://yeasy.gitbook.io/docker_practice/repository/registry
私有仓库</p> <p>https://www.jianshu.com/p/7f920ca189ce
如何在 Ubuntu 安装 Docker ？</p> <p>https://blog.csdn.net/qq_32828933/article/details/104220570
CentOS 8 安装 docker/docker-compose</p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.65b0f24a.js" defer></script><script src="/assets/js/2.d6ca9a42.js" defer></script><script src="/assets/js/111.bd5d0a8b.js" defer></script>
  </body>
</html>
